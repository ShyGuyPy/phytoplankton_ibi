---
title: "pibi_long"
author: "Luke Vawter"
date: "December 21, 2018"
output: html_document
---

####Download Packages
```{r load_packages, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(stringr)
library(leaflet)
library(lubridate)
library(readxl)
library(httr)
library(RCurl)
library(data.table)
library(jsonlite)
library(rprojroot)
library(ritis)
library(parallel)
```

mmir is Zach Smith's custom package
```{r}
library(mmir)
```


####Funcs and Variables
these varaible should be changed by the user as needed
```{r}
#this is the minimum date to be included
min_date = "1-1-2013"
#this is the minimum date to be included sdd the variable todays.date intot his variable if you want the most recent data
max_date = "12-31-2016"
```

variables and functions that will likely not be changed
```{r}
project.dir <- rprojroot::find_rstudio_root_file()

clean_string <- function(x) {
  x %>% 
    stringr::str_trim() %>% 
    tolower() %>% 
    stringr::str_replace_all("\\s+", " ") %>% 
    stringr::str_replace_all(" ", "_") %>%  
    if_else(. == "", as.character(NA), .)
}

clean_up <- function(x) {
  x %>% 
    rename_all(clean_string) %>% 
    mutate_if(is.character, funs(clean_string))%>% 
    distinct()
}

url.root <- "http://datahub.chesapeakebay.net/api.JSON"
todays.date <- format(Sys.Date(), "%m-%d-%Y")


dir.create(file.path(project.dir, "data/VA_ODU/"),
           recursive = TRUE, showWarnings = FALSE)

dir.create(file.path(project.dir, "data/CEDR/"),
           recursive = TRUE, showWarnings = FALSE)

dir.create(file.path(project.dir, "data/MD_DNR/"),
           recursive = TRUE, showWarnings = FALSE)

dir.create(file.path(project.dir, "data/water_quality"),
           recursive = TRUE, showWarnings = FALSE)


station.vec <- file.path(url.root,
                       "LivingResources",
                       "TidalPlankton",
                       "Reported",
                       min_date,
                       # "1-1-2013",
                       max_date, 
                       # "12-31-2016",
                       "17",
                       "Station") %>% 
  fromJSON() %>% 
  pull(unique(MonitoringLocationId))
```

####CEDR data



this pulls the sample and event data from cedr
```{r}
phyto.df <- file.path(url.root,
                      "LivingResources",
                      "TidalPlankton",
                      "Reported",
                       min_date,
                       # "1-1-2013",
                       max_date, 
                       # "12-31-2016",
                      "17",
                      "Station",
                      paste(station.vec, collapse = ",")) %>%
  fromJSON() %>% 
  clean_up()




dir.create(file.path(project.dir, "data/CEDR"),
           recursive = TRUE, showWarnings = FALSE)
phyto.df %>% 
  mutate(reportingvalue = as.character(reportingvalue)) %>% 
data.table::fwrite(file.path(rprojroot::find_rstudio_root_file(), "data/CEDR", "cedr_phyto_taxa.csv"))





event.df <- file.path(url.root,
                      "LivingResources",
                      "TidalPlankton",
                      "MonitorEvent",
                       min_date,
                       # "1-1-2013",
                       max_date, 
                       # "12-31-2016",
                      "17",
                      "Station",
                      paste(station.vec, collapse = ",")) %>%
  fromJSON() %>% 
  clean_up()





dir.create(file.path(rprojroot::find_rstudio_root_file(), "data/CEDR"),
           recursive = TRUE, showWarnings = FALSE)

data.table::fwrite(event.df, file.path(rprojroot::find_rstudio_root_file(), "data/CEDR", "cedr_phyto_event.csv"))
```

### Read csv's t dataframes

CEDR
```{r}
phyto.df <- data.table::fread(file.path(project.dir, "data/CEDR/", "cedr_phyto_taxa.csv")) %>% clean_up() %>% mutate(sampledate=as.Date(sampledate))

event.df <- data.table::fread(file.path(project.dir, "data/CEDR/", "cedr_phyto_event.csv")) %>% clean_up() %>% mutate(sampledate=as.Date(sampledate))

```

####water quality data

download water quality data:
```{r}
wq.df <- file.path(url.root,
                   "WaterQuality",
                   "WaterQuality",
                   format(min(phyto.df$sampledate) - days(3), "%m-%d-%Y"),
                   format(max(phyto.df$sampledate) + days(3), "%m-%d-%Y"), 
                   "6",
                   "7,16,23,24",
                   "station",
                   paste(station.vec, collapse = ","),
                   "21,34,74,83") %>% 
  fromJSON() %>% 
  clean_up()

```


```{r}
data.table::fwrite(wq.df, file.path(project.dir, "data/water_quality", "cedr_wq.csv"))
```


```{r}
wq.df <- data.table::fread(file.path(project.dir, "data/water_quality/cedr_wq.csv"),
                            data.table = FALSE,
                           na.strings = c(""))
```

```{r}
wq_test.df <- wq.df %>%
  filter(!parameter %in% c("chla", "doc", "pheo", "salinity"))
```


this snippet of Zach's code removes any row flagged in the problem column(anything other than na)
28 items are removed from the list
```{r}
wq.df <- wq.df %>%
  filter(is.na(problem)#,
         #parameter %in% c("chla", "doc", "pheo", "salinity") ...removed because these are the only 4 parameters included so
         #the code doesn't actually do anything
         )

wq.df <- wq.df %>%
  select(station, sampledate, layer, depth, parameter, measurevalue) %>% #eventid,
  mutate(sampledate=as.Date(sampledate))
```

####Prep Event

```{r}
phyto.df <- phyto.df %>%
  mutate(sampledate = as.Date(sampledate))
```

```{r}
event.df <- event.df %>%
  mutate(sampledate = as.Date(sampledate))
```

this is Zach's code for use with use for (I believe) older data that uses older salzone designations,
it's doing nothing for our current data set (2013-2016)
```{r}
event.df <- event.df %>%
  mutate(sampledate = as.Date(sampledate),
         salzone = case_when(
           salzone %in% c("tf", "fe") ~ "f",
           salzone %in% c("m", "me") ~ "m",
           salzone %in% c("o", "oe") ~ "o",
           salzone %in% c("p", "pe") ~ "p",
           TRUE ~ as.character(NA)
         ))
```

```{r}
pdepth.df <- event.df %>%
  filter(layer %in% c("ap","wc")) %>%
  mutate(sampledate = as.Date(sampledate)) %>%
  select(station, sampledate, pdepth) %>%
  dplyr::distinct()
```

applies pdepth to water quality dataframe
(should be wq.df or wq_w_pdepth not stat_samp when fixed)
currently wq-9821
na pdepth wq values-2494
```{r}
wq_w_pdepth.df <- left_join(wq.df, pdepth.df, by = c("station", "sampledate"))
```

generates new dataframe with new parameter s_chla (539 items)
```{r}
s_chla.df <- wq_w_pdepth.df %>%
  filter(layer == "s", 
         parameter == "chla") %>% 
  unite(parameter, c("layer", "parameter"), remove = FALSE) %>%
  filter(depth <= pdepth) #%>%
  #filter(parameter=="s_chla")
```

extracting depth integrated dataframe for each parameter
note:doc has 559, and salinity 1578 items where all others have 665
```{r}
di_doc.df <- wq_w_pdepth.df %>%
  filter(depth <= pdepth) %>%
  filter(parameter=="doc") %>%

  group_by(station, sampledate) %>%
  mutate(avg_di_doc = mean(measurevalue, na.rm = TRUE)) %>%
  ungroup()

di_chla.df <- wq_w_pdepth.df %>%
  filter(depth <= pdepth) %>%
  filter(parameter == "chla") %>%

  group_by(station, sampledate) %>%
  mutate(avg_di_chla = mean(measurevalue, na.rm = TRUE)) %>%
  ungroup()

di_salinity.df <- wq_w_pdepth.df %>%
  filter(depth <= pdepth) %>%
  filter(parameter == "salinity") %>%

  group_by(station, sampledate) %>%
  mutate(avg_di_salinity = mean(measurevalue, na.rm = TRUE)) %>%
  ungroup()

di_pheo.df <- wq_w_pdepth.df %>%
  filter(depth <= pdepth) %>%
  filter(parameter == "pheo") %>%

  group_by(station, sampledate) %>%
  mutate(avg_di_pheo = mean(measurevalue, na.rm = TRUE)) %>%
  ungroup()
```

C-  need to apply this to all sample, date combos but want to review with Claire first
```{r}
di_salinity.df <-di_salinity.df %>%

  mutate(salzone = case_when(
    avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
    avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
    avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
    avg_di_salinity > 18~ "P")
  )
```

C- need to add s_chla as well but need to review process with Claire
```{r}
#wq_joined.df <- left_join(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df, by = c("station", "sampledate"))
wq_all.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df))
```

###Taxanmoic data (ITIS)

this is Zach's code.  It's pretty neat.
```{r}
col.class.vec <- c("samplenumber" = "character",
                   "tsn" = "character",
                   "speccode" = "character",
                   "reportingvalue" = "integer")

bay.temp <- data.table::fread(file.path(project.dir,  "data/CEDR/cedr_phyto_taxa.csv"
                                        #"data/phytoplankton2/VA_ODU_phyto_taxa.csv"
                                        ),
                            data.table = FALSE,
                            colClasses = col.class.vec)
```

this test shows that 1794 have a tsn of 0(Zach explains there are no na, only 0, which is annoying)
```{r}
need_tsn.df <- bay.temp %>%
  filter(tsn==0)
```

changed all org_tsn references to tsn, because org_tsn does not exist in bay.temp.
Also, first row is na's and 0's suggesting that the data has a space between the header, and that total number of
ojects(3065) may be one over our actual values
```{r}
hier.wide <- lapply(unique(bay.temp$tsn), function(tsn.i) {
 #print(tsn.i)
  
  if(ncol(usage(tsn.i)) == 0) return(data.frame(tsn = as.integer(tsn.i),
                                                stringsAsFactors = FALSE))
  if(!ritis::usage(tsn.i)$taxonUsageRating %in% c("accepted", "valid")) {
    tsn.accepted <- ritis::accepted_names(as.integer(tsn.i))$acceptedTsn
  } else {
    tsn.accepted <- as.integer(tsn.i)
  }

  full.df <- ritis::hierarchy_full(tsn.accepted) %>%
    select(rankname, taxonname, tsn) %>%
    slice(1:which(tsn == tsn.accepted)) %>%
    mutate(tsn = as.integer(tsn.i),
           final_tsn = as.integer(tsn.accepted),
           final_id = slice(., which(tsn == tsn.accepted))$taxonname)
}
) %>%
  bind_rows() %>%
#   select(-tsn) %>% 
  #spread(rankname, taxonname) %>%
  clean_up()
```

removes the gap mentioned above
```{r}
hier.wide<- hier.wide %>%
  filter(!is.na(taxonname) & !is.na(rankname))
```



####Testing
```{r}
# na <- stat_samp %>%
#   filter(is.na(stat_samp$pdepth))
# 
# not_na <- stat_samp %>%
#   filter(!is.na(stat_samp$pdepth))
```


---
title: "pibi_long"
author: "Luke Vawter"
date: "December 21, 2018"
output: 
  html_document:
    df_print: pagde
    toc: yes
    toc_depth: '6'
    toc_float: yes
---

line 480 under missing_s_chla.df <- name_missing(.... 
```{r}
# creates a vector of the unqiue ids of the missing values
missing_ids.vec <- pull(missing_s_chla.df, eventid) 

# checks ids against source, which is totally redundant
missing_full.df <-wq_above_pdepth.df %>%
  filter(eventid %in% missing_ids.vec ) #eventid
```







TEST STEPS

[on line 181, after pulling in event and sample data]
COMPARE STEP 1
```{r}
step_1.df <- event.df

data.table::fwrite(step_1.df, file.path(project.dir, "data/test", "step_1.csv"))

s1_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step1.csv")) %>% clean_up() #%>% mutate(sampledate=as.Date(sampledate))
```

[on line 375, after 'pdepth.df <- event.df']
COMPARE STEP 2
```{r}
step_2.df <- pdepth.df

data.table::fwrite(step_2.df, file.path(project.dir, "data/test", "step_2.csv"))

s2_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step2.csv")) %>% clean_up() #%>% mutate(sampledate=as.Date(sampledate))
```


[on line 391, above 'wq_above_pdepth.df <- wq_w_pdepth.df%>%
  filter(depth <= pdepth)']
COMPARE STEP 3
note: 7358 to 7358 in Claire's excel
```{r}
step_3.df <- wq_w_pdepth.df

data.table::fwrite(step_3.df, file.path(project.dir, "data/test", "step_3.csv"))

s3_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step3.csv")) %>% clean_up() #%>% mutate(sampledate=as.Date(sampledate))

```

[on line 286]
```{r}
s3_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step3.csv")) %>% clean_up() #%>% 

```
step 3 anti
```{r}
s3_compare_modified.df <- s3_compare.df %>%
  rename(eventid = wq_eventid)


compare_wq_raw.df <- anti_join(wq.df, s3_compare_modified.df, by = c("eventid"))
```

```{r}
station_check <- s3_compare_modified.df %>%
  filter(station %in% c("sbe5"))
```


[line 450, above 'wq_above_pdepth.df <- find_missing(event.df, wq_w_pdepth.df, wq_above_pdepth.df, step_4.vec)' ]
COMPARE STEP 4
note: 3483 to 3483 in Claire's excel
```{r}
step_4.df <- wq_above_pdepth.df

data.table::fwrite(step_4.df, file.path(project.dir, "data/test", "step_4.csv"))

s4_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step4.csv")) %>% clean_up() #%>% mutate(sampledate=as.Date(sampledate))
```

code to compare dataframes for testing step 4:
```{r}
step_4_modified.df <- step_4.df %>%
  mutate(sampledate = as.Date(sampledate)) %>%
  #select(-sampledate, above_pdepth) %>%
  mutate(author = "Luke")

# s4_compare.df <- s4_compare.df %>%
#   mutate(sampledate = as.Date(sampledate))

s4_compare_modified.df <- s4_compare.df %>%
  rename(above_pdepth = `above_p_depth?`) %>%
  rename(eventid = wq_eventid) %>%
  rename(pdepth = p_depth) %>%
  select(station, sampledate, layer, depth, parameter, measurevalue, eventid, pdepth, above_pdepth) %>%
  #select(-sampledate, -above_pdepth) %>%
  mutate(author = "Claire")


```

the objects in diff_check_step_4.df were the 4 entries that exist in Claire's data but not in mine. Exceptions written for such cases, except one which does not exist in my data:
```{r}

#diff_check.df <- left_join(step_4_modified.df, s4_compare_modified.df)


LV_diff_check_step_4.df <- anti_join(step_4_modified.df, s4_compare_modified.df, by = c("station", "depth", "parameter", "measurevalue", "eventid", "pdepth")) #"layer",

C_diff_check_step_4.df <- anti_join(s4_compare_modified.df, step_4_modified.df,  by = c("station", "depth", "parameter", "measurevalue", "eventid", "pdepth")) #"layer",

# author_check.df <- diff_check.df %>%
#   filter(author == "Claire")
```

[line 472, above 'wq_above_pdepth.df <- wq_above_pdepth.df %>%
  group_by(station, sampledate, depth, parameter) %>%']
STEP 5 COMPARE
my 533 to Claire's 531(was 533?)
```{r}
step_5.df <- di_s_chla.df

data.table::fwrite(step_5.df, file.path(project.dir, "data/test", "step_5.csv"))

s5_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step5.csv")) %>% clean_up() #%>% mutate(sampledate=as.Date(sampledate))
```

```{r}
step_5_modified.df <- step_5.df %>%
  mutate(sampledate = as.Date(sampledate)) %>%
  #select(-sampledate, above_pdepth) %>%
  mutate(author = "Luke") %>%
  clean_up() %>%
  mutate(measurevalue_averaged = as.numeric(measurevalue_averaged))

# s5_compare.df <- s5_compare.df %>%
#   mutate(sampledate = as.Date(sampledate))

s5_compare_modified.df <- s5_compare.df %>%
  rename(eventid = wq_eventid) %>%
  rename(measurevalue_averaged = average_of_measurevalue) %>%
  #rename(pdepth = p_depth) %>%
  #select(station, sampledate, layer, depth, parameter, measurevalue, eventid, pdepth, above_pdepth) %>%
  #select(-sampledate, -above_pdepth) %>%
  mutate(author = "Claire") %>%
  clean_up() %>%
  mutate(measurevalue_averaged = as.numeric(measurevalue_averaged))


C_diff_check_step_5.df <- anti_join(s5_compare_modified.df, step_5_modified.df, by = c("station",  "parameter", "measurevalue_averaged", "eventid", "layer"))

C_diff_check_step_5.df <- C_diff_check_step_5.df%>%
  mutate(measure_type = typeof(measurevalue_averaged)) %>%
  filter(eventid==425680 | eventid==394855)

LV_diff_check_step_5.df <- anti_join(step_5_modified.df, s5_compare_modified.df, by = c("station", "measurevalue_averaged", "parameter", "eventid","layer")) 

LV_diff_check_step_5.df <- LV_diff_check_step_5.df%>%
  mutate(measure_type = typeof(measurevalue_averaged))
```


[on line 490, below 'wq_above_pdepth.df <- wq_above_pdepth.df %>%
  group_by(station, sampledate, depth, parameter) %>%']
COMPARE STEP 6 
my 3366 to Claire's is 3357(was 3366)
```{r}
step_6.df <- wq_above_pdepth.df

data.table::fwrite(step_6.df, file.path(project.dir, "data/test", "step_6.csv"))

s6_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step6.csv")) %>% clean_up()

C_diff_check_step_6.df <- anti_join(step_6.df,s6_compare.df, by = c(
  #"station", "depth","parameter", 
  "measurevalue_averaged"
  )) 

LV_diff_check_step_6.df <- anti_join(s6_compare.df, step_6.df, by = c(
  #"station", "depth", "parameter", 
  "measurevalue_averaged")) 


```


COMPARE STEP 7 
mine is 2028 to Claire's 2026(was 2028)
```{r}
step_7.df <- wq_above_pdepth.df

data.table::fwrite(step_7.df, file.path(project.dir, "data/test", "step_7.csv"))

s7_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step7.csv")) %>% clean_up() %>% 
  rename(depth_integrated_value =`depth-integrated_value`)


C_diff_check_step_7.df <- anti_join(step_7.df,s7_compare.df, by = c(#"station", "parameter", 
  "depth_integrated_value")) 

LV_diff_check_step_7.df <- anti_join(s7_compare.df, step_7.df, by = c(#"station", "parameter", 
  "depth_integrated_value")) 
```


[on line 502, above 'wq_warm.df <- wq_all.df %>%']
COMPARE STEP 8
my 2561 to Claire's 2555(was 2558)
```{r}
print(2028 + 533)


step_8.df <- wq_all.df

data.table::fwrite(step_8.df, file.path(project.dir, "data/test", "step_8.csv"))

s8_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step8.csv")) %>% clean_up() %>% 
  rename(depth_integrated_value =`depth-integrated_value`)

C_diff_check_step_8.df <- anti_join(step_8.df,s8_compare.df, by = c("depth_integrated_value")) 

LV_diff_check_step_8.df <- anti_join(s8_compare.df, step_8.df, by = c("depth_integrated_value")) 
```


[on line 590, above 'wq_final.df <- wq_warm.wide %>%']
COMPARE STEP 9
```{r}
step_9.df <- wq_warm.wide

data.table::fwrite(step_9.df, file.path(project.dir, "data/test", "step_9.csv"))

s9_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step9.csv")) %>% clean_up() 

C_diff_check_step_9.df <- anti_join(step_9.df,s9_compare.df, by = c("chla", "s_chla", "pheo", "salinity", "doc")) 

LV_diff_check_step_9.df <- anti_join(s9_compare.df, step_9.df, by = c("chla", "s_chla", "pheo", "salinity", "doc")) 
```


[on line 598, below 'wq_final.df <- wq_warm.wide %>%']
COMPARE STEP 10
```{r}
step_10.df <- wq_final.df

data.table::fwrite(step_10.df, file.path(project.dir, "data/test", "step_10.csv"))

s10_compare.df <- data.table::fread(file.path(project.dir, "data/test/", "C_step10.csv")) %>% clean_up() 

C_diff_check_step_10.df <- anti_join(step_10.df,s10_compare.df, by = c("chla", "s_chla", "pheo", "salinity", "doc")) 

LV_diff_check_step_10.df <- anti_join(s10_compare.df, step_10.df, by = c("chla", "s_chla", "pheo", "salinity", "doc"))
```













```{r}
  metric.vec <- c("total_nano_micro_biomass_chla_ratio",
                  "surface_chla",
                  "chla",
                  "doc",
                  "pheophytin",
                  "total_nano_micro_biomass", 
                  "diatom_biomass",
                  "dinoflagellate_biomass",
                  "cyanophyte_biomass",
                  "cryptophyte_biomass",
                  "pct_cryptophyte",
                  "prorocentrum_minimum_abundance", 
                  "microcystis_aeruginosa_abundance",
                  #"pico_reportingvalue" 
                  "picoplankton_abundance"
                  
                  )
```

```{r}

# test1 <- full_join(carbon.df, bay.df, by = c("latinname","size","tsn", "group", "nodc_phyla")) %>%
#   filter(station == "tf5.5" & sampledate == "2013-03-05") %>%
#   filter(!is.na(reportingvalue)) %>%
#   distinct()
# 
# test2 <- left_join(bay.df, carbon.df, by = c("latinname","size","tsn")) %>%
#   filter(station == "tf5.5" & sampledate == "2013-03-05") %>%
#   rename(group = group.y) %>%
#   rename(nodc_phyla = nodc_phyla.y) %>%
#   select(-group.x, -nodc_phyla.x) %>%
#   distinct()
# 
# test3 <- anti_join(test1, test2)
# 
# test4 <- bay.df %>%
#   select(-nodc_phyla, -group) 
# 
# test5 <- left_join(test4, carbon.df, by = c("latinname","size","tsn")) %>%
#   distinct()
# 
# test6 <- anti_join(test5, test2)
# 

```

clean up bay_merged(make group and nodc_phyla from carbon_list primary variable and remove value brought in from bay.df)
```{r}
# bay_merged.df <- bay_merged.df %>%
#   rename(group = group.y) %>%
#   rename(nodc_phyla = nodc_phyla.y) %>%
#   select(-group.x, -nodc_phyla.x) %>%
#   distinct()
```

fixes to carbon_list such as assigning tsn to latinnames with known tsns
```{r}
test_carbon.df <- carbon.df %>%
  mutate(size = ifelse(size =="unidentified", as.character(NA), size)) %>%
  mutate(tsn = case_when(latinname == "aphanizomenon_issatschenkoi"~as.integer(1191), 
                         latinname == "chaetoceros_neogracilis"~as.integer(1004011), 
                         latinname =="guinardia_striata" ~ as.integer(2921), 
                         latinname == "lagerheimia" ~ as.integer(6017), 
                         latinname == "odontella_alternans"~ as.integer(573604),
                         #latinname == "protoperidinium_orbiculare" ~ as.integer(), 
                         latinname == "psuedosolenia_calcar-avis" ~ as.integer(970064),
                         
                         #over-writes tsn of 591037 for the itis tsn of 591383
                         latinname == "pleurosigma_obscurum" ~ as.integer(591383),
                         
                         TRUE ~ as.integer(tsn))) 
```

ln 758
was used to correct typo in jackie data dataframe.  corrected in source instead (carbon_lisr_2014)
```{r}
  #mutate(size = ifelse(size =="microphytoflaggelates", "microphytoflagellates", size)) %>%
```



carbon adjustments

L. this code requires the diameter variable from the carbon sheet in jackie's data.  We are currently using the biomass_estimates sheet.  To run this code(if it is determined to be necessary), you will need to import the carbon sheet from jackie's data and append the diameter variable through a join.
```{r}
# carbon.df <- carbon.df %>% 
#   mutate(size = case_when(
#     size %in% "unidentified" ~ as.character(NA),
#     str_detect(size, "species|sp.") ~ str_replace_all(size, "sp.#|species_#|species_|species", "sp#"),
#     TRUE ~size
#   ),
#   latinname = if_else(latinname == "blue_green_trichome", "blue_green_sphere", latinname)) %>% 
#   mutate(picoplankton = if_else(
#     diameter <= 20 &
#       height <= 20 &
#       width <= 20 &
#       width <= 20 &
#       height_2 <= 20 &
#       width_2 <= 20,
#     TRUE,
#     FALSE
#   )) %>% 
#   select(latinname, size, carbon) %>%
#   distinct() %>% 
#   bind_rows(data.frame(latinname = "asterionellopsis_glacialis", 
#                        carbon = carbon.df[carbon.df$latinname == "asterionellopsis_kariana", "carbon"],
#                        stringsAsFactors = FALSE))
```

```{r}
wq_warm_sal_added.df <- left_join(wq_warm_sal.df, wq_sal_filled.df, by= c("concat", "salzone","station","sampledate", "season"))

# test to determine if we are retaining the right values
test.df <- anti_join(wq_warm.df, wq_warm_sal_added.df,  by = c("concat", "station","sampledate", "season", "parameter", "month", "depth_integrated_value"))
```

```{r}
wq_no_sal.df <- anti_join(wq_warm_sal.df, wq_sal_id.df, by = c("concat"))

wq_sal_fill.df <-  wq_no_sal.df %>%
  distinct(concat, station, sampledate, season, salzone) %>%
  mutate(salzone = case_when((station %in% c("cb1.1", "tf2.3", "tf4.2","tf5.5" ) & is.na(salzone)) | (season == "spring" & station %in% c("et5.1", "tf1.5")& is.na(salzone))
         ~ "F", TRUE ~ salzone  ))

#test number of exceptions above code is catching
wq_sal_filled.df <- wq_sal_fill.df %>%
  filter(salzone == "F")

# test for number of na salzone values remaining
test_na.df <- wq_sal_fill.df %>%
  filter(is.na(salzone))
```
this is a check to see if any wq.df sampledate values fall outside of the date range.  None do
```{r}
print(min(wq.df$sampledate))

print(max(wq.df$sampledate))

narrow_date_range.df <-  wq.df %>%
  mutate(sampledate = as.Date(sampledate)) %>%
  filter( sampledate < as.Date("2013-1-1'") |  sampledate > as.Date("2016-12-31"))


```

"ProjectId":7,"ProjectIdentifier":"MAIN","ProjectName":"Tidal Mainstem Water Quality Monitoring Project"
"ProjectId":16,"ProjectIdentifier":"PART","ProjectName":"Tidal Non-Traditional Partners"
"ProjectId":23,"ProjectIdentifier":"TRIB","ProjectName":"Tidal Tributary Water Quality Monitoring Project"
"ProjectId":24,"ProjectIdentifier":"TSPECIAL","ProjectName":"Special Tidal Water Quality Monitoring Project"

```{r}
missing_other.df <- wq.df %>%
  mutate(sampledate = as.Date(sampledate)) %>%
  #filter(eventid == 394855 %>% 
  filter(totaldepth <= 5 & station %in% c("tf3.3","tf4.2","tf5.5", "ret3.1","ret4.3","ret3.1")) 
  #filter( station %in% c("tf3.3","tf4.2","tf5.5", "ret3.1","ret4.3","ret3.1") &  (is.na(layer)) |!layer %in% c("s","f","m","p", "ap","b", "bp"))
```

```{r}
# test <- scores_ratings_final %>%
#   mutate(test = (diatom_biomass + dinoflagellate_biomass + cryptophyte_biomass + cyanophyte_biomass)) %>%
#   select(total_biomass, total_nano_micro_biomass, test)
```

```{r}
# test_id <-  metrics_prep.df %>%
#   select(unique_id) %>%
#   distinct()
# 
# test2 <- scores_ratings_final %>%
#   filter(unique_id == "cb6.1_ap_fs1_2016-04-27") %>%
#   distinct()


  



```

```{r}
# 
# test <- scores_ratings_final %>%
#   filter(unique_id == "cb6.1_ap_fs1_2016-04-27")
# 
# test1 <- test %>%
#   mutate_at(vars(ends_with("_score")), list( 
#   ~case_when(.== "0" ~ " ", TRUE~ .)))
# 
# test2 <- test %>%
#   mutate_at(vars(ends_with("_score")), list( 
#   ~case_when(.== 0 ~ " ", TRUE~ as.character(.))))

```

```{r}
# test_flatten <- test %>%
#   group_by(unique_id) %>%
#   #mutate(test = n()
#   mutate(diatom_biomass = sum(diatom_biomass, na.rm=T)) %>%
#   mutate(cyanophyte_biomass = sum(cyanophyte_biomass, na.rm=T)) %>%
#   mutate(dinoflagellate_biomass = sum(dinoflagellate_biomass / 2, na.rm=T)) %>%
#   #mutate(cyanophyte_biomass = sum(dinoflagellate_biomass, na.rm=T)) %>%
#   mutate(cryptophyte_biomass = sum(cryptophyte_biomass, na.rm=T)) %>%
#   mutate(prorocentrum_minimum_abundance = sum(prorocentrum_minimum_abundance, na.rm=T)) %>%
#   mutate(microcystis_aeruginosa_abundance = sum(microcystis_aeruginosa_abundance, na.rm=T)) %>%
#   
#   
#   #mutate(total_nano_micro_biomass = sum(total_nano_micro_biomass, na.rm=T)) %>% 
#   #mutate(total_nano_micro_biomass_chla_ratio = sum(total_nano_micro_biomass_chla_ratio, na.rm=T)) %>%
#   
#   mutate(pct_cryptophyte = sum(pct_cryptophyte, na.rm=T)) %>%
#   #mutate(surface_chla = sum(surface_chla, na.rm=T)) %>%
#   #mutate(pheophytin = sum(pheophytin, na.rm=T)) %>%
#   distinct() %>%
#   ungroup()
```


TEST_STARTS_HERE

add a unique_id to match Zach's scoring function later on
replacing concat with it
```{r}
# bay_full_calc.df <- bay_full_calc.df %>%
#   mutate(unique_id = paste(station, layer, samplenumber, sampledate, sep = "_")) %>%
#   select(-concat) #%>%
#   #select(-reported_size, -surveyid, -fieldactivityid, -source, -sampletype, -gmethod, -tsn, -latinname, -size, -method, -parameter, -reportingunit, -nodccode, -serialnumber, -month, -season, -reportingvalue, -new_size, -nodc_phyla, -group, -speccode, -carbon) %>%
#   distinct()
```

```{r}
# bay_wq_merged_calc.df <-  bay_wq_merged_calc.df  %>%
#   
# 
#   group_by(unique_id) %>%
#   
#   
#   mutate(total_biomass = sum(carbon)) %>%
#   mutate(total_nano_micro_biomass = sum(nano_micro_biomass)) %>%
#   
#   select(-nano_micro_biomass) %>%
#   
# 
#   mutate(carbon_chlorophyll_ratio = total_nano_micro_biomass/chla) %>%
#   
#   group_by(group, add=TRUE) %>%
# 
#   mutate(diatom_biomass = case_when(group == "diatom"~sum(carbon)/1000000, TRUE ~ as.numeric(NA))) %>%
#   mutate(dinoflagellate_biomass = case_when(group == "dinoflagellates"~sum(carbon)/1000000, TRUE ~ as.numeric(NA))) %>%
#   mutate(cyanophyte_biomass = case_when(group == "cyanophyte"| group == "cyanobacteria"~sum(carbon)/1000000, TRUE ~ as.numeric(NA))) %>%
#   mutate(cryptophyte_biomass = case_when(group == "cryptophyte" | group == "cryptophyceae" | group == "cryptophyta" | group == "cryptomonads"~sum(carbon), TRUE ~ as.numeric(NA))) %>%
#   
#   mutate(percent_cryptophyte_biomass = cryptophyte_biomass/total_nano_micro_biomass)%>%
#   
#   
# 
#   ungroup() %>%
#   select(-group, -carbon) %>%
#   distinct()
# 


```

I have eventid 39855 with s_chla in my wq data
this is the check:
```{r}
mystery.df <- wq_above_pdepth.df %>%
  filter(eventid == 394855)

mystery2.df <- event.df %>%
  filter(station == "tf4.2" & sampledate =="2014-07-15")
  
mystery3.df <- wq.df %>%
  filter(eventid == 394855)

mystery4.df <- di_s_chla.df %>%
  filter(eventid == 394855)
```

```{r}
# #finds instances of station/sampledate combo that are missing from wq
# missing.df <- anti_join(event.df,wq_above_pdepth.df, by = c("station", "sampledate"))
# 
# #standardize date format and add a unique identifier to missing 
# missing.df <- missing.df %>%
#   mutate( sampledate =  as.Date(sampledate)) %>%
#   mutate(concat = paste0(station, sampledate))
# 
# #standardize date format and add a unique identifier to wq
# wq_w_pdepth.df <- wq_w_pdepth.df %>%
#   mutate( sampledate =  as.Date(sampledate)) %>%
#   mutate(concat = paste0(station, sampledate))
# 
# #create a vector to store concatinated ids from the missing combos
# concat_vector2.vec <- pull(missing.df, concat)
# 
# #uses the combos in missing.df to retrieve the event data for the missing values
# missing_full.df <-wq_w_pdepth.df %>%
#   filter(concat %in% concat_vector2.vec) 
# 
# #adds a concat id to wq_above_pdepth
# wq_above_pdepth.df <- wq_above_pdepth.df %>%
#   mutate( sampledate =  as.Date(sampledate)) %>%
#   mutate(concat = paste0(station, sampledate))
# 
# #joins the missing values back into most recent wq df
# wq_above_pdepth.df <- full_join(wq_above_pdepth.df, missing_full.df, by = c("station", "sampledate", "layer", "pdepth", "concat", "depth", "parameter", "measurevalue", "above_pdepth", "eventid"))
```

test script for step 3
```{r}
# step_3_test.df <- step_3.df %>%
#   group_by(eventid) %>% #, sampledate) %>%
#   mutate(total_in_group = n()) %>%
#   summarise() %>%
#   ungroup()
#   
# s3_compare.df <- s3_compare.df %>%
#   mutate( sampledate =  as.Date(sampledate, format = '%m/%d/%Y'))
# 
# s3_compare_test.df <- s3_compare.df %>%
#   group_by(wq_eventid) %>%
#   mutate(total_in_group = n()) %>%
#   summarise() %>%
#   ungroup()
# 
# id_vector <- pull(s3_compare_test.df, wq_eventid)
# 
# step_3_by_id <-wq.df %>%
#   filter(eventid %in% id_vector)
# 
# step_3_to_exclude <- wq.df %>%
#   filter(!eventid %in% id_vector)
# 
# s3_wq_dates.df <- data.table::fread(file.path(project.dir, "data/test/", "wq_dates.csv")) %>% clean_up() %>%
#   mutate( sampledate =  as.Date(sampledate, format = '%m/%d/%Y'))
#   # group_by(sampledate) %>%
#   # mutate(total_in_group = n()) %>%
#   # summarise() %>%
#   # ungroup()
# 
# test_7358 <- step_3.df %>%
#   #filter(is.na(problem))
#   filter(layer %in% c("s","a","p","m")) %>%
# 
# test_missing <-  

  
```

filters out dpeths below pdepth
making an exception for any data missing pdepth of station tf4.2
by joining data that meet that criteria back in
```{r}
# missing_pdepth.df <- wq_w_pdepth.df %>%
#   filter( (is.na(pdepth)& station %in% c("tf3.3","tf4.2","tf5.5", "ret3.1","ret4.3","ret3.1")) 
# )
# 
# missing_other_pd.df <- left_join(missing_other.df, pdepth.df, by = c("station", "sampledate")) %>%
#   filter(totaldepth <= 5 & station %in% c("ret3.1","ret4.3") & pdepth <=1 ) 

```

```{r}
base <- scores_ratings_final %>%
  select(-total_nano_micro_biomass_chla_ratio_score,	-surface_chla_score,	-cyanophyte_biomass_score,	-doc_score,	-pheophytin_score,	-total_nano_micro_biomass_score,	-diatom_biomass_score,	-dinoflagellate_biomass_score,	-prorocentrum_minimum_abundance_score,	-pct_cryptophyte_score,	-microcystis_aeruginosa_abundance_score,	-picoplankton_abundance_score,	-ibi_score
)

scores <- scores_ratings_final %>%
    select(unique_id,total_nano_micro_biomass_chla_ratio_score,	surface_chla_score,	cyanophyte_biomass_score,	doc_score,	pheophytin_score,	total_nano_micro_biomass_score,	diatom_biomass_score,	dinoflagellate_biomass_score,	prorocentrum_minimum_abundance_score,	pct_cryptophyte_score,	microcystis_aeruginosa_abundance_score,	picoplankton_abundance_score,	ibi_score
)


scores[scores == 0] <- " "

scores_ratings_final <- full_join(base, scores, by = c("unique_id"))
```




```{r}
test <- all_seasons 

  test[is.na(test)] <- 0 
  
test2 <- test %>%  
  #mutate(spice = nrow(total_phyto_biomass:nrow())) %>%
  group_by(unique_id) %>%
  mutate(pepper = mean(total_phyto_biomass:nrow(.)))
```


 mutate(total_phyto_biomass_chla_ratio_rating = case_when(
      total_phyto_biomass_chla_ratio < 39.28 ~1,
      total_phyto_biomass_chla_ratio>= 39.28 & total_phyto_biomass_chla_ratio <= 41.72 ~ 3,
      total_phyto_biomass_chla_ratio > 41.72 ~ 5,
      TRUE ~ as.numeric(NA))) %>%
  
  mutate(surface_chla_rating = case_when(
      surface_chla < 3.42 & surface_chla > 14.45~1,
      (surface_chla >= 3.42 & surface_chla <= 4.37) |(surface_chla >= 13.98 & surface_chla <= 14.45) ~ 3,
      surface_chla > 4.37 & surface_chla < 13.98 ~ 5,
      TRUE ~ as.numeric(NA))) %>%
  
  mutate(surface_chla_rating = case_when(
      surface_chla < 3.42 & surface_chla > 14.45~1,
      (surface_chla >= 3.42 & surface_chla <= 4.37) |(surface_chla >= 13.98 & surface_chla <= 14.45) ~ 3,
      surface_chla > 4.37 & surface_chla < 13.98 ~ 5,
      TRUE ~ as.numeric(NA))) %>%
  
  mutate(cyanophyte_biomass_rating = case_when(
      cyanophyte_biomass > 23.02 ~ 1,
      cyanophyte_biomass <= 23.02 ~ as.numeric(NA))) %>%
  
  mutate(doc_rating = case_when(
      doc > 2.40 ~ 1,
      doc >= 2.19 & doc <= 2.40 ~ 3,
      doc  < 2.19 ~ 5,
      TRUE ~ as.numeric(NA))) %>%
  
  mutate(pheophytin_rating = case_when(
      pheophytin > 2.50 ~ 1,
      pheophytin >= 1.55 & pheophytin <= 2.50 ~ 3,
      pheophytin < 1.55 ~ 5,
      TRUE ~ as.numeric(NA))) %>%
  
  mutate(total_phyto_biomass_rating = case_when(
      total_phyto_biomass <= 172.99 | total_phyto_biomass > 828.5 ~ 1,
      total_phyto_biomass >= 583.9 & total_phyto_biomass <= 828.5 ~ 3,
      total_phyto_biomass > 172.99 & total_phyto_biomass < 583.9 ~ 5,
      TRUE ~ as.numeric(NA))) 

apply and ibi score
```{r}
all_seasons <- all_seasons %>%
  group_by(unique_id) %>% 
  mutate(ibi_score = mean(score, na.rm = TRUE)) %>%
  ungroup()  

```









































```{r}
test <- metrics_prep.df %>%
  filter( (season == "summer" & salzone == "F") | (season == "summer" & salzone == "f")) %>%
  distinct()
```
gather into long format
```{r}
metrics.long <- metrics_prep.df %>% 
  gather(metric, value, metric.vec)#chla:pico_reportingvalue)
```

```{r}
test <- metrics.long %>%
  filter( (season == "summer" & salzone == "F") | (season == "summer" & salzone == "f")) %>%
  distinct()
```

```{r}
metrics <- unique(pull(metrics.long, metric))
print(metrics)
```








below are the scoring functions for each alzone and season:

Spring Freshwater
```{r}
score_spring_f <- function(metrics.long) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "cyanophyte_biomass",
                  "doc",
                  "pheophytin",
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "spring", 
           salzone == "f",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_spring_f requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      # Jackie's code 39.28 and 41.72
      # Lacouture (2006) 39.3 and 41.7
      metric == "total_phyto_biomass_chla_ratio" & value < 39.28 ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 39.28 & value <= 41.72 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 41.72 ~ 5,
      metric == "surface_chla" & (value < 3.42 | value > 14.45) ~ 1,
      metric == "surface_chla" & ((value >= 3.42 & value <= 4.37) |(value >= 13.98 & value <= 14.45)) ~ 3,
      metric == "surface_chla" & value > 4.37 & value < 13.98 ~ 5,
      # Jackie's code 23.02
      # Lacouture (2006) 23
      metric == "cyanophyte_biomass" & value > 23.02 ~ 1,
      metric == "cyanophyte_biomass" & value <= 23.02 ~ as.numeric(NA),
      metric == "doc" & value > 2.40 ~ 1,
      metric == "doc" & value >= 2.19 & value <= 2.40 ~ 3,
      metric == "doc" & value < 2.19 ~ 5,
      metric == "pheophytin" & value > 2.50 ~ 1,
      metric == "pheophytin" & value >= 1.55 & value <= 2.50 ~ 3,
      metric == "pheophytin" & value < 1.55 ~ 5,
      # Jackie's code 172.99, 583.9, and 828.5
      # Lacouture (2006) 173, 584, and 829
      metric == "total_phyto_biomass"  & (value <= 172.99 | value > 828.5) ~ 1,
      metric == "total_phyto_biomass"  & value >= 583.9 & value <= 828.5 ~ 3,
      metric == "total_phyto_biomass"  & value > 172.99 & value < 583.9 ~ 5,
      TRUE ~ as.numeric(NA)))
  return(final.df)
}

```


Spring Oligohaline
```{r}
score_spring_o <- function(metrics.long) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "doc",
                  "pheophytin",
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "spring", 
           salzone == "o",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_spring_o requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>%
    mutate(score = case_when(
      metric == "total_phyto_biomass_chla_ratio" & (value < 18.8 | value > 48.6) ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 18.8 & value <= 21.2 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 21.2 & value < 48.6 ~ 5,
      metric == "surface_chla" & (value < 6.77 | value > 33.64) ~ 1,
      metric == "surface_chla" & ((value >= 20.93 & value <= 33.64) |(value >= 6.77 & value <= 8.82)) ~ 3,
      metric == "surface_chla" & value > 8.82 & value < 20.93 ~ 5,
      metric == "doc" & value > 3.27 ~ 1,
      metric == "doc" & value >= 2.69 & value <= 3.27 ~ 3,
      metric == "doc" & value < 2.69 ~ 5,
      metric == "pheophytin" & value > 2.68 ~ 1,
      metric == "pheophytin" & value >= 2.23 & value <= 2.68 ~ 3,
      metric == "pheophytin" & value < 2.23 ~ 5,
      # Jackie's code 133.67, 426.31, 131.37, and 685.81
      # Lacouture (2006) 134, 426, 131, and 686
      metric == "total_phyto_biomass"  & value > 133.67 & value < 426.31 ~ 5,
      metric == "total_phyto_biomass"  & ((value >= 131.37 & value <= 133.67) | (value >= 426.31 & value < 685.81)) ~ 3,
      metric == "total_phyto_biomass"  & any(value < 131.37 | value >= 685.81) ~ 1,
      TRUE ~ as.numeric(NA)))
  return(final.df)
}

```

Spring Mesohaline
```{r}
score_spring_m <- function(metrics.long) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "diatom_biomass",
                  "dinoflagellate_biomass",
                  "doc",
                  "pheophytin",
                  "prorocentrum_minimum_abundance",
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "spring", 
           salzone == "m",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_spring_m requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)],
                     collapse = ", ")))
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      # Jackie's code 69.52 and 45.04
      # Lacouture (2006) 69.5 and 45
      metric == "total_phyto_biomass_chla_ratio" & value < 45.04 ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 45.04 & value <= 69.52 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 69.52 ~ 5,
      metric == "surface_chla" & (value < 2.60 | value > 8.00) ~ 1,
      metric == "surface_chla" & ((value >= 2.60 & value <= 2.90) |(value >= 6.17 & value <= 8.00)) ~ 3,
      metric == "surface_chla" & value > 2.90 & value < 6.17 ~ 5,
      # Jackie's code 275.4
      # Lacouture (2006) 275
      metric == "diatom_biomass" & (value < 149 | value >= 2513) ~ 1,
      metric == "diatom_biomass" & value >= 149 & value <= 275.4 ~ 3,
      metric == "diatom_biomass" & value > 275.4 & value < 2513 ~ 5,
      # Jackie's code 28.3, 156.9, and 268.2
      # Lacouture (2006) 157 and 268
      metric == "dinoflagellate_biomass" & (value < 28.3 | value > 268.2) ~ 1,
      metric == "dinoflagellate_biomass" & value >= 156.9 & value <= 268.2 ~ 3,
      metric == "dinoflagellate_biomass" & value > 28.3 & value < 156.9 ~ 5,
      metric == "doc" & value > 3.17 ~ 1,
      metric == "doc" & value >= 2.84 & value <= 3.17 ~ 3,
      metric == "doc" & value < 2.84 ~ 5,
      metric == "pheophytin" & value > 1.03 ~ 1,
      metric == "pheophytin" & value >= 1.00 & value <= 1.03 ~ 3,
      metric == "pheophytin" & value < 1.00 ~ 5,
      metric == "prorocentrum_minimum_abundance" & value > 1477600 ~ 1,
      metric == "prorocentrum_minimum_abundance" & value <= 1477600 ~ as.numeric(NA),
      metric == "total_phyto_biomass"  & value > 1150 ~ 1,
      metric == "total_phyto_biomass"  & value <= 1150 ~ as.numeric(NA),
      TRUE ~ as.numeric(NA)))
  return(final.df)
}

```

Spring Polyhaline
```{r}
score_spring_p <- function(metrics.long) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "pct_cryptophyte",
                  "doc",
                  "pheophytin",
                  "prorocentrum_minimum_abundance",
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "spring", 
           salzone == "p",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_spring_p requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      metric == "total_phyto_biomass_chla_ratio" & value < 71.0 ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 71.0 & value <= 107.5 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 107.5 ~ 5,
      metric == "surface_chla" & value > 4.00 ~ 1,
      metric == "surface_chla" & value >= 2.80 & value <= 4.00 ~ 3,
      metric == "surface_chla" & value < 2.80 ~ 5,
      # Jackie's code 4.93 and 7.06
      # Lacouture (2006) 4.9 and 7.1
      metric == "pct_cryptophyte" & value > 7.06 ~ 1,
      metric == "pct_cryptophyte" & value >= 4.93 & value <= 7.06 ~ 3,
      metric == "pct_cryptophyte" & value < 4.93 ~ 5,
      metric == "doc" & value > 2.61 ~ 1,
      metric == "doc" & value >= 2.50 & value <= 2.61 ~ 3,
      metric == "doc" & value < 2.50 ~ 5,
      metric == "pheophytin" & value > 0.90 ~ 1,
      metric == "pheophytin" & value >= 0.55 & value <= 0.90 ~ 3,
      metric == "pheophytin" & value < 0.55 ~ 5,
      metric == "prorocentrum_minimum_abundance" & value > 7488 ~ 1,
      metric == "prorocentrum_minimum_abundance" & value >= 672 & value <= 7488 ~ 3,
      metric == "prorocentrum_minimum_abundance" & value < 672 ~ 5,
      # Jackie's code 1061.7
      # Lacouture (2006) 1062
      metric == "total_phyto_biomass"  & value > 1061.7 ~ 1,
      metric == "total_phyto_biomass"  & value <= 1061.7 ~ as.numeric(NA),
      TRUE ~ as.numeric(NA)))
  return(final.df)
}

```

Summer Freshwater
```{r}
score_summer_f <- function(metrics.long) {
  metric.vec <- c("surface_chla",
                  "cyanophyte_biomass",
                  "diatom_biomass",
                  "doc", 
                  "microcystis_aeruginosa_abundance",
                  "pheophytin", 
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "summer", 
           salzone == "f",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_summer_f requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      metric == "surface_chla" & value > 12.30 ~ 1,
      metric == "surface_chla" & ((value >= 12.00 & value <= 12.30) | value <= 5.4) ~ 3,
      metric == "surface_chla" & value > 5.40 & value < 12.00 ~ 5,
      # Jackie's code 38.87 and 67.4
      # Lacouture (2006) 39 and 67
      metric == "cyanophyte_biomass" & value > 67.4 ~ 1,
      metric == "cyanophyte_biomass" & value >= 38.87 & value <= 67.4 ~ 3,
      metric == "cyanophyte_biomass" & value < 38.87 ~ 5,
      # Jackie's code 122.1 and 192.6
      # Lacouture (2006) 122 and 193
      metric == "diatom_biomass" & value > 192.6 ~ 1,
      metric == "diatom_biomass" & value >= 122.1 & value <= 192.6 ~ 3,
      metric == "diatom_biomass" & value < 122.1 ~ 5,
      metric == "doc" & value > 3.18 ~ 1,
      metric == "doc" & value >= 2.67 & value <= 3.18 ~ 3,
      metric == "doc" & value < 2.67 ~ 5,
      metric == "microcystis_aeruginosa_abundance" & value > 262507 ~ 1,
      metric == "microcystis_aeruginosa_abundance" & value <= 262507 ~ as.numeric(NA),
      metric == "pheophytin" & value > 4.30 ~ 1,
      metric == "pheophytin" & value >= 2.40 & value <= 4.30 ~ 3,
      metric == "pheophytin" & value < 2.40 ~ 5,
      # Jackie's code 231.3 and 555.7
      # Lacouture (2006) 232 and 551
      metric == "total_phyto_biomass"  & value > 555.7 ~ 1,
      metric == "total_phyto_biomass"  & value < 231.3 ~ 3,
      metric == "total_phyto_biomass"  & value >= 231.3 & value <= 555.7 ~ 5,
      TRUE ~ as.numeric(NA)))
  return(final.df)
}
```

Summer Oligohaline
```{r}
score_summer_o <- function(metrics.long) {
  metric.vec <- c("surface_chla",
                  "cyanophyte_biomass",
                  "diatom_biomass",
                  "doc",
                  "pheophytin")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "summer", 
           salzone == "o",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_summer_o requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      metric == "surface_chla" & value >= 9.47 ~ 1,
      metric == "surface_chla" & value <= 4.20 ~ 3,
      metric == "surface_chla" & value > 4.20 & value < 9.47 ~ 5,
      # Jackie's code 1.79 and 26.55
      # Lacouture (2006) 1.8 and 27
      metric == "cyanophyte_biomass" & value >= 26.55 ~ 1,
      metric == "cyanophyte_biomass" & value < 1.79 ~ 3,
      metric == "cyanophyte_biomass" & value >= 1.79 & value < 26.55 ~ 5,
      # Jackie's code 44.14 and 126.59
      # Lacouture (2006) 44 and 127
      metric == "diatom_biomass" & value >= 126.59 ~ 1,
      metric == "diatom_biomass" & value <= 44.14 ~ 3,
      metric == "diatom_biomass" & value > 44.14 & value < 126.59 ~ 5,
      metric == "doc" & value > 4.00 ~ 1,
      metric == "doc" & value >= 3.15 & value <= 4.00 ~ 3,
      metric == "doc" & value < 3.15 ~ 5,
      metric == "pheophytin" & value > 2.81 ~ 1,
      metric == "pheophytin" & value >= 1.58 & value <= 2.81 ~ 3,
      metric == "pheophytin" & value < 1.58 ~ 5,
      TRUE ~ as.numeric(NA)))
  return(final.df)
}
```

Summer Mesohaline
```{r}
score_summer_m <- function(metrics.long, pico.warning) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "dinoflagellate_biomass", 
                  "doc",
                  "pheophytin",
                  "total_phyto_biomass")
  pico.vec <- "picoplankton_abundance"
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "summer", 
           salzone == "m",
           metric %in% c(metric.vec, pico.vec))
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_summer_m requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  
  if (pico.warning == TRUE && any(!pico.vec %in% unique(metrics.sub$metric))) {
    warning("Warning: picoplankton_abundance missing from score_summer_m")
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      metric == "total_phyto_biomass_chla_ratio" & value < 32.2 ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 32.2 & value <= 36.9 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 36.9 ~ 5,
      metric == "surface_chla" & value >= 9.74 ~ 1,
      metric == "surface_chla" & ((value >= 7.70 & value < 9.74) | value <= 4.00) ~ 3,
      metric == "surface_chla" & value > 4.00 & value < 7.70 ~ 5,
      # Jackie's code 200.92, 31.22, 55.98
      # Lacouture (2006) 201, 31, 56
      metric == "dinoflagellate_biomass" & (value <= 31.22 | value > 200.92) ~ 1,
      metric == "dinoflagellate_biomass" & value > 31.22 & value <= 55.98 ~ 3, 
      metric == "dinoflagellate_biomass" & value > 55.98 & value < 200.92 ~ 5,
      metric == "doc" & value > 3.35 ~ 1,
      metric == "doc" & value >= 2.99 & value <= 3.35 ~ 3,
      metric == "doc" & value < 2.99 ~ 5,
      metric == "pheophytin" & value > 1.60 ~ 1,
      metric == "pheophytin" & value >= 1.23 & value <= 1.60 ~ 3,
      metric == "pheophytin" & value < 1.23 ~ 5,
      # Jackie's code 598720000
      # Lacouture (2006) 598700000
      metric == "picoplankton_abundance" & value < 352000000 ~ 1,
      metric == "picoplankton_abundance" & value >= 352000000 & value <= 598720000 ~ 3,
      metric == "picoplankton_abundance" & value > 598720000 ~ 5,
      metric == "total_phyto_biomass"  & value > 660 ~ 1,
      metric == "total_phyto_biomass"  & value <= 660 ~ as.numeric(NA),
      TRUE ~ as.numeric(NA)))
  return(final.df)
}
```

Summer Polyhaline
```{r}
score_summer_p <- function(metrics.long, pico.warning) {
  
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "pct_cryptophyte",
                  "diatom_biomass",
                  "dinoflagellate_biomass",
                  "doc",
                  "pheophytin",
                  "total_phyto_biomass")
  pico.vec <- "picoplankton_abundance"
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "summer", 
           salzone == "p",
           metric %in% c(metric.vec, pico.vec))
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_summer_p requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
  
  if (pico.warning == TRUE && any(!pico.vec %in% unique(metrics.sub$metric))) {
    warning("Warning: picoplankton_abundance missing from score_summer_p")
  }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      metric == "total_phyto_biomass_chla_ratio" & value < 37.7 ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 37.7 & value <= 74.5 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 74.5 ~ 5,
      metric == "surface_chla" & value > 5.33 ~ 1,
      metric == "surface_chla" & value >= 4.52 & value <= 5.33 ~ 3,
      metric == "surface_chla" & value < 4.52 ~ 5,
      metric == "pct_cryptophyte" & value > 6.5 ~ 1,
      metric == "pct_cryptophyte" & value >= 3.9 & value <= 6.5 ~ 3,
      metric == "pct_cryptophyte" & value < 3.9 ~ 5,
      metric == "diatom_biomass" & (value >= 799 | value < 137) ~ 1,
      metric == "diatom_biomass" & value >= 137 & value <= 181 ~ 3,
      metric == "diatom_biomass" & value > 181 & value < 799 ~ 5,
      metric == "dinoflagellate_biomass" & (value < 23 | value >= 544) ~ 1,
      metric == "dinoflagellate_biomass" & value >= 23 & value <= 37 ~ 3, 
      metric == "dinoflagellate_biomass" & value > 37 & value < 554 ~ 5,
      metric == "doc" & value > 2.80 ~ 1,
      metric == "doc" & value >= 2.58 & value <= 2.80 ~ 3,
      metric == "doc" & value < 2.58 ~ 5,
      metric == "pheophytin" & value > 1.50 ~ 1,
      metric == "pheophytin" & value >= 0.93 & value <= 1.50 ~ 3,
      metric == "pheophytin" & value < 0.93 ~ 5,
      metric == "picoplankton_abundance" & value < 208600000 ~ 1,
      metric == "picoplankton_abundance" & value >= 208600000 & value <= 269500000 ~ 3,
      metric == "picoplankton_abundance" & value > 269500000 ~ 5,
      # In Jackie's code 718
      # Lacouture (2006) 711
      metric == "total_phyto_biomass"  & (value < 181 | value > 831) ~ 1,
      metric == "total_phyto_biomass"  & ((value >= 181 & value <= 207) | (value >= 718 & value <= 831)) ~ 3,
      metric == "total_phyto_biomass"  & value > 207 & value < 718 ~ 5,
      TRUE ~ as.numeric(NA)))
  return(final.df)
}
```

generate scores
```{r}
  spring.f <- score_spring_f(metrics.long)
  spring.o <- score_spring_o(metrics.long)
  spring.m <- score_spring_m(metrics.long)
  spring.p <- score_spring_p(metrics.long)
  #----------------------------------------------------------------------------
  summer.f <- score_summer_f(metrics.long)
  summer.o <- score_summer_o(metrics.long)
  summer.m <- score_summer_m(metrics.long, pico.warning = FALSE)
  summer.p <- score_summer_p(metrics.long, pico.warning = FALSE)
```


Test determines that this part of Zach's score_summer_f function is producing as set of data that is reduced to 27(from 1006) when distinct is applied to it.
```{r}

  test_metric.vec <- c("surface_chla",
                  "cyanophyte_biomass",
                  "diatom_biomass",
                  "doc", 
                  "microcystis_aeruginosa_abundance",
                  "pheophytin", 
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  test_metrics.sub <- metrics.long %>% 
    filter(season == "summer", 
           salzone == "f", 
           metric %in% metric.vec) %>%
  distinct()
```


```{r}
test <- summer.f %>%
  filter( (season == "summer" & salzone == "F") | (season == "summer" & salzone == "f")) %>%
  distinct()
```

```{r}
all_seasons <- bind_rows(spring.f,spring.o,spring.m,spring.p,summer.f,summer.o,summer.m,summer.p)
```

```{r}
#tf3.3_ap_fs1_2016-03-17
#2013-03-05

test <-  all_seasons%>%
  filter(station == "tf3.3" & sampledate == "2016-03-17")
```

```{r}
test <- all_seasons %>%
  filter( (season == "summer" & salzone == "F") | (season == "summer" & salzone == "f")) %>%
  distinct()
```

apply and ibi score
```{r}
all_seasons <- all_seasons %>%
  group_by(unique_id) %>% 
  mutate(ibi_score = mean(score, na.rm = TRUE)) %>%
  ungroup()  

```

```{r}
# all_seasons_test <- all_seasons %>%
#   mutate(
#     metric_count = n(),
#     present_count = sum(!is.na(score)),
#     na_count = sum(is.na(score))) %>% 
#   ungroup() %>% 
#   filter(present_count >= 4)
```


```{r}
rate_phyto <- function(scores.df) {
  final.df <- scores.df %>% 
    mutate(
      ibi_score = round(ibi_score, 2),
      rating = case_when(
        ibi_score < 2 ~ "poor",
        ibi_score >= 2 & ibi_score < 2.67 ~ "fair_poor",
        ibi_score >= 2.67 & ibi_score < 3.33 ~ "fair",
        ibi_score >= 3.33 & ibi_score < 4 ~ "fair_good",
        ibi_score >= 4 ~ "good",
        TRUE ~ "ERROR"
      ))
  return(final.df)
}
```


```{r}
all_seasons.rating <- rate_phyto(all_seasons)
```

```{r}
# ratings_test <- rate_phyto(all_seasons_test)
```



```{r}
# test <- ratings_test %>%
#   distinct()
```

after  correct spread apply ratings
```{r}
#disable scientific notation
options(scipen=999)



scores_ratings_final.long <- all_seasons.rating %>%

  select(unique_id, salzone, season, station, sampledate, samplenumber, metric,value, score, ibi_score, rating) %>%
  distinct() %>%
  #mutate(score = if_else(is.na(score),0, score)) %>%
  group_by(metric) %>%
  ungroup()
  
  
  #select(concat, salzone, metric, value) %>%
  #filter(value != 0.000000e+00) %>%
  #spread(metric, value) 

  #code for spreading without dups(thanks Rikke)
  # data <- data %>%
  #    group_by(grouping_variable) %>%
  #    mutate(grouped_id = row_number())  %>%
  #    spread( grouping_variable  , RESULT_VALUE) %>%
  #    select(-grouped_id)
```






```{r}
test2 <- scores_ratings_final.long %>%
  #select(unique_id) %>%
  distinct()
```

after  correct spread apply ratings
  
```{r}
scores_ratings_final.long %>% 
data.table::fwrite(file.path(rprojroot::find_rstudio_root_file(), "data/ScoresRatings", "final_scores_ratings_long.csv"))
```


currently not spreading properly
```{r}
scores_ratings_final.wide <- all_seasons.rating %>%
  select(unique_id, station, season, sampledate, samplenumber, salzone, metric, value, ibi_score, rating) %>%
  #group_by(unique_id) %>%
  mutate(grouped_id = row_number())  %>%

  spread(metric  , value) %>%
  select(-grouped_id) %>%


  
  distinct() #%>%
  #ungroup()
```

```{r}

test <-  all_seasons.rating %>% 
  select(-unique_id, -station, -sampledate, -samplenumber, -salzone, -ibi_score, -rating, -score, -season) %>%
  mutate(grouped_id = row_number())  %>%

  spread(metric  , value) %>%
  select(-grouped_id) %>%
  distinct()
```

```{r}
scores_ratings_final.wide %>% 
data.table::fwrite(file.path(rprojroot::find_rstudio_root_file(), "data/ScoresRatings", "final_scores_ratings_wide.csv"))
```

LATEST_TEST
```{r}
test_bay_test_SF <- bay_wq_merged.df %>%
  filter( season == "summer" & salzone == "F") %>%
  distinct()

test_bay_test_SO <- bay_wq_merged.df %>%
  filter( season == "summer" & salzone == "O") %>%
  distinct()

test_scores_SO <-  scores_ratings_final.long %>%
    filter( season == "summer" & salzone == "o")

test_scores_SF <- scores_ratings_final.long %>%
  filter( season == "summer" & salzone == "f")

test_scores_SO_w <-  scores_ratings_final.wide %>%
    filter( season == "summer" & salzone == "o")

test_scores_SF_w <- scores_ratings_final.wide %>%
  filter( season == "summer" & salzone == "f")

test_seasons <-  all_seasons %>%
  filter( season == "summer" & salzone == "f") %>%
  distinct()
  
```




Scoring Wrapper Function


```{r}
score_phyto <- function(metrics.long, pico.warning) {
  #----------------------------------------------------------------------------
  spring.f <- score_spring_f(metrics.long)
  spring.o <- score_spring_o(metrics.long)
  spring.m <- score_spring_m(metrics.long)
  spring.p <- score_spring_p(metrics.long)
  #----------------------------------------------------------------------------
  summer.f <- score_summer_f(metrics.long)
  summer.o <- score_summer_o(metrics.long)
  summer.m <- score_summer_m(metrics.long, pico.warning)
  summer.p <- score_summer_p(metrics.long, pico.warning)
  #----------------------------------------------------------------------------
  final.df <- bind_rows(spring.f, spring.o, spring.m, spring.p,
                        summer.f, summer.o, summer.m, summer.p) %>% 
    select(-layer)
  #----------------------------------------------------------------------------
  return(final.df)
}
```

```{r}
scores.df <- metrics.long %>% 
  separate(unique_id, c("station", "layer", "samplenumber",
                        "sampledate", "season", "salzone"), sep = "_",
           remove = FALSE) %>% 
  rename(date = sampledate) %>% 
  score_phyto(pico.warning = FALSE) %>% 
  select(-samplenumber)
```




```{r}
score_test <- function(metrics.long) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "cyanophyte_biomass",
                  "doc",
                  "pheophytin",
                  "total_phyto_biomass")
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "spring", 
           salzone == "f",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  if (any(!metric.vec %in% unique(metrics.sub$metric))) {
    stop(paste("score_spring_f requires the following metric(s):",
               paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  }
}
```

```{r}
score_phyto <- function(metrics.long, pico.warning) {
  #----------------------------------------------------------------------------
  spring.f <- score_spring_f(metrics.long)
  spring.o <- score_spring_o(metrics.long)
  spring.m <- score_spring_m(metrics.long)
  spring.p <- score_spring_p(metrics.long)
  #----------------------------------------------------------------------------
  summer.f <- score_summer_f(metrics.long)
  summer.o <- score_summer_o(metrics.long)
  summer.m <- score_summer_m(metrics.long, pico.warning)
  summer.p <- score_summer_p(metrics.long, pico.warning)
  #----------------------------------------------------------------------------
  final.df <- bind_rows(spring.f, spring.o, spring.m, spring.p,
                        summer.f, summer.o, summer.m, summer.p) %>% 
    select(-layer)
  #----------------------------------------------------------------------------
  return(final.df)
}
```
```

```{r}
score_test(metrics.long)
```




```{r}
missing_carbon.df <- bay_merged.df %>%
  filter(is.na(carbon) | carbon == 0)
```

```{r}
missing <- unique(pull(missing_carbon.df, latinname))
#print(missing)

missing_green_blue.df <- missing_carbon.df %>%
  filter(latinname %in% c("green_cells", "blue_green_sphere"))

missing_sans_green_blue.df <- missing_carbon.df %>%
  filter(!latinname %in% c("green_cells", "blue_green_sphere"))

missing_actual <- unique(pull(missing_sans_green_blue.df, latinname))
sort(missing_actual)
print(missing_actual)



test <- carbon.df %>%
  filter(latinname %in% missing)


# 
# missing_actual <- unique(pull(test, tsn))
# 
# test2 <- bay.df %>%
#   filter(tsn %in% missing2)
  
```



26 missing carbon(minus green_cells and bluegreen_sphere)
```{r}
missing_but_in_carbon.df <- carbon.df %>%
  filter(latinname %in% c("centritractis_belonophorus", "cerataulina", "characium", "coelosphaerium_dubium", "corethron_hystrix", "crucigenia_truncata", "cylindrospermopsis","euglenophycota", "limnothrix", "odontella",  "oocystis_pusilla", "oocystis_pyriformis", "protoperidinium_bipes" , "staurastrum_manfeldtii", "woronichinia_naegeliana"))

```

```{r}
missing_b_i_c.vec <- unique(pull(missing_but_in_carbon.df, latinname))

test <- bay_merged.df %>%
  filter(latinname %in% missing_b_i_c.vec)
```






caught a spelling error in carbon_list:
chlorophyceae microphytoflagellates
chlorophyceae microphytoflaggelates


asterionellopsis_glacialis


```{r}
test <- bay.df %>%
  filter(latinname =="microcystis_aeruginosa" | latinname=="prorocentrum_minimum") #%>%
```




 [1] "chla"                             "doc"                             
 [3] "pheophytin"                       "surface_chla"                    
 [5] "salinity"                         "total_biomass"                   
 [7] "total_phyto_biomass"              "total_phyto_biomass_chla_ratio"  
 [9] "diatom_biomass"                   "dinoflagellate_biomass"          
[11] "cyanophyte_biomass"               "cryptophyte_biomass"             
[13] "percent_cryptophyte_biomass"      "procentrum_minimum_abundance"    
[15] "microcystis_aeruginosa_abundance" "pico_reportingvalue" 

```{r}
select out: salinity, total_biomass
```

```{r}
score <- function(metrics.long, score_season, score_salzone) {
  metric.subset <- metrics.long %>%
    filter(season == score_season,
           salzone == score_salzone,
           metric %in%  metric.vec)
}
```


```{r}
score_spring_f <- function(metrics.long) {
  metric.vec <- c("total_phyto_biomass_chla_ratio",
                  "surface_chla",
                  "chla",
                  "doc",
                  "pheophytin",
                  "total_phyto_biomass", 
                  "diatom_biomass",
                  "dinoflagellate_biomass",
                  "cyanophyte_biomass",
                  "cryptophyte_biomass",
                  "percent_cryptophyte_biomass",
                  "procentrum_minimum_abundance", 
                  "microcystis_aeruginosa_abundance",
                  "pico_reportingvalue" 
                  
                  )
  #----------------------------------------------------------------------------
  metrics.sub <- metrics.long %>% 
    filter(season == "spring", 
           salzone == "f",
           metric %in% metric.vec)
  #----------------------------------------------------------------------------
  # if (any(!metric.vec %in% unique(metrics.sub$metric))) {
  #   stop(paste("score_spring_f requires the following metric(s):",
  #              paste(metric.vec[!metric.vec %in% unique(metrics.sub$metric)], collapse = ", ")))
  # }
  #----------------------------------------------------------------------------
  final.df <- metrics.sub %>% 
    mutate(score = case_when(
      # Jackie's code 39.28 and 41.72
      # Lacouture (2006) 39.3 and 41.7
      metric == "total_phyto_biomass_chla_ratio" & value < 39.28 ~ 1,
      metric == "total_phyto_biomass_chla_ratio" & value >= 39.28 & value <= 41.72 ~ 3,
      metric == "total_phyto_biomass_chla_ratio" & value > 41.72 ~ 5,
      metric == "surface_chla" & (value < 3.42 | value > 14.45) ~ 1,
      metric == "surface_chla" & ((value >= 3.42 & value <= 4.37) |(value >= 13.98 & value <= 14.45)) ~ 3,
      metric == "surface_chla" & value > 4.37 & value < 13.98 ~ 5,
      # Jackie's code 23.02
      # Lacouture (2006) 23
      metric == "cyanophyte_biomass" & value > 23.02 ~ 1,
      metric == "cyanophyte_biomass" & value <= 23.02 ~ as.numeric(NA),
      metric == "doc" & value > 2.40 ~ 1,
      metric == "doc" & value >= 2.19 & value <= 2.40 ~ 3,
      metric == "doc" & value < 2.19 ~ 5,
      metric == "pheophytin" & value > 2.50 ~ 1,
      metric == "pheophytin" & value >= 1.55 & value <= 2.50 ~ 3,
      metric == "pheophytin" & value < 1.55 ~ 5,
      # Jackie's code 172.99, 583.9, and 828.5
      # Lacouture (2006) 173, 584, and 829
      metric == "total_phyto_biomass"  & (value <= 172.99 | value > 828.5) ~ 1,
      metric == "total_phyto_biomass"  & value >= 583.9 & value <= 828.5 ~ 3,
      metric == "total_phyto_biomass"  & value > 172.99 & value < 583.9 ~ 5,
      TRUE ~ as.numeric(NA)))
  return(final.df)
}
```






code for modifying carbon list
```{r}

carbon_change.df <- readxl::read_excel(file.path(project.dir, "data/carbon/carbon_list_2014_old.xlsx"),
                         sheet = "OldBiomassEstimates") %>% clean_up()

carbon_change.df <- carbon_change.df %>%
  mutate(group =ifelse(group =="chlorophycota", "chlorophyta", group )) %>%
  mutate(lbl = ifelse(lbl=="protoperidinium_bipes", "minuscula_bipes", lbl)) %>%
  mutate(lbl = ifelse(lbl=="woronichinia_naegeliana", "coelosphaerium_naegelianum", lbl)) %>%
  mutate(lbl = ifelse(lbl=="centritractis_belonophorus", "centratractus_belonophorus", lbl)) %>%
  mutate(tsn = ifelse(tsn==10210, 10209, tsn)) %>%
  mutate(tsn = ifelse(lbl=="woronichinia_naegeliana", 0, tsn))

data.table::fwrite(carbon_change.df, file.path(project.dir, "data/carbon", "carbon_list_2014.csv"))
```

```{r}
test <- taxa.raw %>% 
  filter(latinname == "centritractis_belonophorus" | latinname== "centratractus_belonophorus")
```

test spelling
```{r}
carbon_check.df <- readxl::read_excel(file.path(project.dir, "data/carbon/carbon_list_2014_old.xlsx"),
                         sheet = "OldBiomassEstimates") %>% clean_up()

carbon_ll <-  carbon_check.df %>%
  filter(size == "microphytoflagellates")

carbon_gg <-  carbon_check.df %>%
  filter(size == "microphytoflaggelates")

taxa_ll <- taxa.raw %>%
  filter(size == "microphytoflagellates")

taxa_gg <- taxa.raw %>%
    filter(size == "microphytoflaggelates")
```

worms
```{r}
library(worms)

test_w <- wormsbynames("limnothrix")
#"limnothrix"
```


itis and carbon

ITIS
```{r}
col.class.vec <- c("samplenumber" = "character",
                   "tsn" = "integer",
                   "speccode" = "character",
                   "reportingvalue" = "integer")

bay.temp <- data.table::fread(file.path(project.dir, "data/CEDR/cedr_phyto_taxa.csv"),
                            data.table = FALSE,
                            colClasses = col.class.vec)

# bay.temp <- bay.temp %>%
#   mutate(tsn =)
```

re-write the code above
```{r}
hier.wide <- lapply(unique(bay.temp$tsn), function(tsn.i) {
  if(ncol(usage(tsn.i)) == 0) return(data.frame(tsn = as.integer(tsn.i),
                                                stringsAsFactors = FALSE))
  if(!ritis::usage(tsn.i)$taxonUsageRating %in% c("accepted", "valid")) {
    tsn.accepted <- ritis::accepted_names(as.integer(tsn.i))$acceptedTsn
  } else {
    tsn.accepted <- as.integer(tsn.i)
  }  
  
    
  full.df <- ritis::hierarchy_full(tsn.accepted) %>% 
    select(rankname, taxonname, tsn) %>% 
    slice(1:which(tsn == tsn.accepted)) %>% 
    mutate(tsn = as.integer(tsn.i),
           final_tsn = as.integer(tsn.accepted),
           final_id = slice(., which(tsn == tsn.accepted))$taxonname)
    
}) %>% 
  bind_rows() %>% 
  #select(-tsn) %>% 
  spread(rankname, taxonname) %>% 
  clean_up()
```

```{r}
column.vec <- c("tsn", "final_tsn", "final_id",
                "kingdom", "subkingdom", "infrakingdom", 
                "superdivision", "division", "subdivision", "infradivision",
                "superphylum", "phylum", "subphylum", "infraphylum", 
                "superclass", "class", "subclass", "infraclass", 
                "superorder", "order", "suborder", "infraorder", 
                "superfamily", "family", "subfamily", 
                "tribe", "subtribe", 
                "genus", "subgenus", 
                "species", "subspecies")

column.vec <- column.vec[column.vec %in% names(hier.wide)]
```

```{r}
hier.wide <- hier.wide[, column.vec]
```

```{r}
dir.create(file.path(project.dir, "data/itis"),
           recursive = TRUE, showWarnings = FALSE)

data.table::fwrite(hier.wide, file.path(rprojroot::find_rstudio_root_file(), "data/itis", "itis_hierarchy.csv"))
```

L.TEST output master taxa
```{r}
# test <- hier.wide %>%
#   filter(final_id %in% c("chlorophyta", "cyanobacteria"))
# 
# dir.create(file.path(project.dir, "data/itis"),
#            recursive = TRUE, showWarnings = FALSE)
# 
# data.table::fwrite(hier.wide, file.path(rprojroot::find_rstudio_root_file(), "data/itis", "itis_hierarchy_test.csv"))
```



test old itis data vs new
```{r}
# itis_old.df <- data.table::fread(file.path(project.dir, "data/itis/", "old_itis_hierarchy.csv")) %>% clean_up()
# itis_new.df <- data.table::fread(file.path(project.dir, "data/itis/", "itis_hierarchy.csv")) %>% clean_up()
# 
# itis_compare.df <- anti_join(itis_old.df,itis_new.df, by = c("final_id", "final_tsn"))
# itis_also_compare.df <- anti_join(itis_new.df,itis_old.df, by = c("final_id", "final_tsn"))
```



```{r}
col.class.vec <- c("samplenumber" = "character",
                   "tsn" = "character",
                   "speccode" = "character")

taxa.raw <- data.table::fread(file.path(project.dir, "data/CEDR/cedr_phyto_taxa.csv"),
                            data.table = FALSE,
                            colClasses = col.class.vec,
                            na.strings = "") %>% 
  mutate(sampledate = as.Date(sampledate))
```




```{r}
bay.df <- taxa.raw %>% 
  filter(layer %in% c("ap", "wc")) %>% 
  distinct() %>% 
  mutate(month = month(sampledate),
         season = case_when(
           month %in% c(3, 4, 5) ~ "spring",
           month %in% c(7, 8, 9) ~ "summer",
           TRUE ~ "remove"
         )) %>% 
  filter(season %in% c("spring", "summer")) %>%
  #changing types to match as is done in Zach's code using col.class.vec
  mutate(tsn=as.character(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))
  
```


If there are multiple taxa with the same taxonomic name, then the reporting values should be summed. Each row should represent a unique taxon. (currently removes a single value)
```{r}
bay.df <- bay.df %>% 
  group_by_at(vars(-reportingvalue)) %>% 
  summarize(reportingvalue = sum(reportingvalue)) %>% 
  ungroup()
```


```{r}
bay.df <- bay.df %>% 
  filter(grepl("ph", method),
         !latinname %in% c("micro-phytoflagellates",
                           "microflagellates",
                           #"green_cells",
                           #"blue_green_sphere",
                           "epiphytic_flagellates",
                           "hydrodictyon_reticulatum"))
```

Taxaonmic Hierarchy
```{r}
hier.wide <- data.table::fread(file.path(project.dir, "data/itis/itis_hierarchy.csv"),
                            data.table = FALSE,
                            na.strings = "") %>% 
  clean_up() %>%
  #added by Luke
  #should it be org_tsn_or final_tsn
  #mutate(tsn = org_tsn) %>%
  
  #more of Zach's code
  mutate(tsn=as.character(tsn))
```

Z. The taxonomic counts are joined with the taxonomic hierarchy data by the final_tsn columns. A unique identifier (unique_id) is created for each sampling event by concatenating station, layer, samplenumber, and sampledate.
```{r}
bay.df <- left_join(bay.df, hier.wide, by = "tsn") %>% 
  mutate(unique_id = paste(station, layer, samplenumber, sampledate, sep = "_"))
```

Z. Some taxa require specific attention before they can be finalized.
```{r}
bay.df <- bay.df %>% 
  mutate(
    final_id = if_else(latinname == "trinacria_regina", "trinacria_regina",  final_id),
    final_id = case_when(
      latinname == "green_cells" ~ "green_cells",
      latinname == "blue_green_spheres" ~ "blue_green_spheres",
      TRUE ~ final_id
    ),
    kingdom = if_else(latinname == "trinacria_regina",
                      "chromista", kingdom),
    phylum = if_else(latinname == "trinacria_regina",
                     "bacillariophyta", phylum),
    subphylum = if_else(latinname == "trinacria_regina",
                        "bacillariophytina", subphylum),
    class = if_else(latinname == "trinacria_regina",
                    "mediophyceae", class),
    subclass = if_else(latinname == "trinacria_regina",
                       "chaetocerotophycidae", subclass),
    order = if_else(latinname == "trinacria_regina",
                    "hemiaulales", order),
    family = if_else(latinname == "trinacria_regina",
                     "hemiaulaceae", family),
    genus = case_when(latinname == "trinacria_regina" ~ "trinacria",
                      latinname == "didymocystis" ~ "didymocystis",
                      latinname == "Lauterborniella_elegantissima" ~ "lauterborniella",
                      TRUE ~ genus),
    species = case_when(latinname == "trinacria_regina" ~ "trinacria_regina",
                        latinname == "lauterborniella_elegantissima" ~ "lauterborniella_elegantissima",
                        TRUE ~ species)
  )
```

Prepate Carbon Assignments
grab old carbon
```{r}
carbon.df <- readxl::read_excel(file.path(project.dir, "data/carbon/carbon_list_2014.xlsx"),
                                sheet = "carbon_list_2014") %>% 
  clean_up() %>% 
  
  #deselcting several fields
  dplyr::select(-dplyr::contains("new"),
                -smyayda_carbon,
                -difference,
                -shape_change) %>% 
  dplyr::rename(carbon = old_carbon)
```


this fills in 100 tsn with current data (760 missing to 660)
```{r}
bay.df <- bay.df %>% 
  mutate(
    tsn = as.integer(tsn),
    tsn = case_when(
      latinname == "navicula_notablis" ~ as.integer(4327),
      latinname == "pleurosigma_macrum" ~ as.integer(4650),
      latinname == "pleurosigma_obscurum" ~ as.integer(591383),
      latinname == "polykrikos_hartmannii" ~ as.integer(331299),
      latinname == "protoperidinium_aciculiderum" ~ as.integer(10329),
      latinname == "protoperidinium_paulseni" ~ as.integer(3568),
      latinname == "scrippsiella_favionese" ~ as.integer(10537),
      latinname == "tetrastrum_caudatum" ~ as.integer(5691),
      latinname == "didymocystis" ~ as.integer(5810),
      latinname == "lauterborniella_elegantissima" ~ as.integer(6097),
      latinname == "characium_sp." ~ as.integer(5756),
      latinname == "cylindrospermopsis_sp." ~ as.integer(203689),
      latinname == "chaetoceros_neogracilis" ~ as.integer(1004011),
      latinname == "navicula_retusa_cancellata" ~ as.integer(1020372),
      latinname == "karlodinium_micrum" ~ as.integer(180904),
      latinname == "lagerheimia" ~ as.integer(6017),
      latinname == "quadricoccus_euryhalinicus" ~ as.integer(957939),
      latinname == "scrippsiella_precaria" ~ as.integer(10536),
      latinname == "psuedosolenia_calcar-avis" ~ as.integer(970064),
      latinname == "centronella" ~ as.integer(970064),
      latinname == "amphidinium_tatrae" ~ as.integer(9997),
      latinname == "navicula_lata" ~ as.integer(4450),
      latinname == "nitzschia_vitrea_recta" ~ as.integer(5204),
      latinname == "rhaphoneis_gemmifera" ~ as.integer(3145),
      latinname == "delphineis_surirella" ~ as.integer(969978),
      latinname == "navicula_annulata" ~ as.integer(3649),
      latinname == "proboscia_alata_gracillima" ~ as.integer(610099),
      latinname == "guinardia_striata" ~ as.integer(2921),
      latinname == "guinardia_cylindrus" ~ as.integer(2921),
      latinname == "aphanizomenon_issatschenkoi" ~ as.integer(1191),
      latinname == "helicotheca_tamesis" ~ as.integer(590815),
      latinname == "corethron_valdivae" ~ as.integer(2386),
      latinname == "gonyaulax_conjuncta" ~ as.integer(10359),
      latinname == "lioloma_delicatulum" ~ as.integer(573597),
      latinname == "syracosphaera_histrica" ~ as.integer(2234),
      latinname == "rhizosolenia_formosa" ~ as.integer(2879),
      latinname == "proboscla_alata_curvirostris" ~ as.integer(610099),
      latinname == "membraneis_challengeri" ~ as.integer(3648),
      latinname == "chrysococcus_tesselatus" ~ as.integer(1751),
      latinname == "rhoicosphenia_abbreviata" ~ as.integer(3633),
      latinname == "protoperidinium_aciculiferum" ~ as.integer(10340),
      latinname == "protoperidinium_fimbriatum" ~ as.integer(10340),
      latinname == "licmophora_inflata" ~ as.integer(3155),
      latinname == "biddulphia_reticulata" ~ as.integer(2678),
      latinname == "caloneis_lepidula" ~ as.integer(4369),
      latinname == "caloneis_trinodis" ~ as.integer(4369),
      latinname == "amphiprora_cholnokyi" ~ as.integer(4674),
      latinname == "navicula_interrupta" ~ as.integer(3649),
      latinname == "cerataulus_radiatus" ~ as.integer(2709),
      latinname == "gyrosigma_balticum_silimis" ~ as.integer(4623),
      latinname == "dictyocha_siderea" ~ as.integer(1804),
      latinname == "odontella_alternans" ~ as.integer(573604),
      latinname == "nitzschia_vitrea_salinarum" ~ as.integer(5204),
      latinname == "proboscla_alata_indica" ~ as.integer(610099),
      latinname == "attheya_decora" ~ as.integer(2876),
      latinname == "synedra_closterioides" ~ as.integer(970065),
      latinname == "trinacria_regina" ~ as.integer(2747),
      latinname == "chattonella" ~ as.integer(969917),
      latinname == "chattonella_subsalsa" ~ as.integer(969917),
      latinname == "heterosigma_akashiwo" ~ as.integer(969917),
      latinname == "vibrio_fisheri" ~ as.integer(959178),
      TRUE ~ as.integer(tsn)
    )
  )
```

```{r}
carbon.df <- carbon.df %>% 
  mutate(size = case_when(
    size %in% "unidentified" ~ as.character(NA),
    str_detect(size, "species|sp.") ~ str_replace_all(size, "sp.#|species_#|species_|species", "sp#"),
    TRUE ~size
  ),
  latinname = if_else(latinname == "blue_green_trichome", "blue_green_sphere", latinname)) %>% 
  mutate(picoplankton = if_else(
    diameter <= 20 &
      height <= 20 &
      width <= 20 &
      width <= 20 &
      height_2 <= 20 &
      width_2 <= 20,
    TRUE,
    FALSE
  )) %>% 
  select(latinname, size, carbon) %>%
  distinct() %>% 
  bind_rows(data.frame(latinname = "asterionellopsis_glacialis", 
                       carbon = carbon.df[carbon.df$latinname == "asterionellopsis_kariana", "carbon"],
                       stringsAsFactors = FALSE))
```

check for duplicate values
```{r}
carbon.dups <- carbon.df %>% 
  group_by(latinname, size) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  filter(count > 1)
```

excluding 3 types that have dups
```{r}
carbon.df <- carbon.df %>% 
  filter(!(latinname == "chaetoceros_wighami" & is.na(carbon)),
         !(latinname == "biddulphia" & carbon == 7899.50),
         !(latinname == "gymnodinium" & carbon == 848))
```

Identify all taxa (latinname) in bay.df that do not have a size equivalent in carbon.df.

```{r}
no.match.df <- anti_join(bay.df, carbon.df, by = c("latinname", "size")) %>% 
  select(latinname, size) %>% 
  distinct()
```

Z. Attempt to find partial matches for taxa in no.match.df. Each row in no.match.df represents a unique taxon and size combination. lapply loops through each row, extracts the unique size string, splits the string into smaller pieces, and attempts to find partial matches with associated size strings in carbon.df. The string in carbon.df with the most partial matches will be used to replace the size string in bay.df.

```{r}
partial.match.df <- lapply(1:nrow(no.match.df), function(row.i) {
  sub.df <- no.match.df %>% 
    slice(row.i)
  
  size.vec <- str_split(sub.df$size, "_") %>% unlist()
  
  getmode <- function(v) {
    uniqv <- unique(v)
    uniqv[which.max(tabulate(match(v, uniqv)))]
  }
  
  
  carbon.sub <- carbon.df %>% 
    filter(latinname == sub.df$latinname) %>% 
    mutate(row_max_matches = sapply(size.vec, function(size.i) grep(size.i, size)) %>% 
             unlist() %>% 
             getmode()) %>% 
    slice(unique(row_max_matches)) %>% 
    select(-row_max_matches, -carbon) %>% 
    rename(new_size = size) %>% 
    mutate(size = sub.df$size)
  
  return(carbon.sub)
}) %>% 
  bind_rows()
```

Z. Merge bay.df with partial.match.df and if a new_size is present from partial.match.df, then replace the size string with the new_size string. By updating the size strings it is possible to obtain more matches when merging bay.df and  carbon.df.
```{r}
bay_partials_added.df <- left_join(bay.df, partial.match.df, by = c("latinname", "size")) %>% 
  mutate(reported_size = size,
         size = if_else(!is.na(new_size), new_size, size))
```

L. change string of 'not_applicable' to NA value
```{r}
bay_partials_added.df <- bay_partials_added.df %>%
  mutate(size = case_when(size == "not_applicable"~ as.character(NA), TRUE ~size))
```


Z. Merge bay.df with carbon.df and calculate biomass. The phytoplankton counts are reported in picoliters. Biomass is converted to microliters.
```{r}
bay_merged.df <- left_join(bay_partials_added.df, carbon.df, by = c("latinname", "size")) %>% 
  mutate(micro_biomass = reportingvalue * carbon / 10 ^ 6)

```



test to see how many have missing info
note: missing tsn is 465(down from 756), missing carbon is 226(142 of those are green_cells)(down from 9832)
note: there are 24 without carbon values in carbon.df
```{r}
missing_tsn.df <- bay_merged.df %>%
  filter(is.na(tsn) | tsn == 0)

missing_carbon.df <- bay_merged.df %>%
  filter(is.na(carbon) | carbon == 0)
```

```{r}
print(missing_tsn_names <- unique(missing_tsn.df$latinname))

print(missingcarbon_names <- unique(missing_carbon.df$latinname))
```























Taxanomic steps
currently using Zach's code mostly unmodified at this point(change as needed)

update TSNs

```{r}
# col.class.vec <- c("samplenumber" = "character",
#                    "tsn" = "character",
#                    "reportingvalue" = "integer")
# 
# bay.temp <- data.table::fread(file.path(project.dir,  "data/CEDR/cedr_phyto_taxa.csv"
#                                         #"data/phytoplankton2/VA_ODU_phyto_taxa.csv"
#                                         ),
#                             data.table = FALSE,
#                             colClasses = col.class.vec)
```

```{r}
bay.df <- phyto.df %>% 
  filter(layer %in% c("ap", "wc")) %>% 
  distinct() %>% 
  mutate(month = month(sampledate),
         season = case_when(
           month %in% c(3, 4, 5) ~ "spring",
           month %in% c(7, 8, 9) ~ "summer",
           TRUE ~ "remove"
         )) %>% 
  filter(season %in% c("spring", "summer")) %>%
  #changing types to match as is done in Zach's code using col.class.vec
  mutate(tsn=as.character(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))
  
```


If there are multiple taxa with the same taxonomic name, then the reporting values should be summed. Each row should represent a unique taxon.
```{r}
bay.df <- bay.df %>% 
  group_by_at(vars(-reportingvalue)) %>% 
  summarize(reportingvalue = sum(reportingvalue)) %>% 
  ungroup()
```


```{r}
bay.df <- bay.df %>% 
  filter(grepl("ph", method),
         !latinname %in% c("micro-phytoflagellates",
                           "microflagellates",
                           #"green_cells",
                           #"blue_green_sphere",
                           "epiphytic_flagellates",
                           "hydrodictyon_reticulatum"))
```

Taxaonmic Hierarchy
```{r}
hier.wide <- data.table::fread(file.path(project.dir, "data/itis/itis_hierarchy.csv"),
                            data.table = FALSE,
                            na.strings = "") %>% 
  clean_up() %>%
  mutate(tsn=as.character(tsn))
```

Z. The taxonomic counts are joined with the taxonomic hierarchy data by the final_tsn columns. A unique identifier (unique_id) is created for each sampling event by concatenating station, layer, samplenumber, and sampledate.
```{r}
bay.df <- left_join(bay.df, hier.wide, by = "tsn") %>% 
  mutate(unique_id = paste(station, layer, samplenumber, sampledate, sep = "_"))
```

Z. Some taxa require specific attention before they can be finalized.
```{r}
bay.df <- bay.df %>% 
  mutate(
    final_id = if_else(latinname == "trinacria_regina", "trinacria_regina",  final_id),
    final_id = case_when(
      latinname == "green_cells" ~ "green_cells",
      latinname == "blue_green_spheres" ~ "blue_green_spheres",
      TRUE ~ final_id
    ),
    kingdom = if_else(latinname == "trinacria_regina",
                      "chromista", kingdom),
    phylum = if_else(latinname == "trinacria_regina",
                     "bacillariophyta", phylum),
    subphylum = if_else(latinname == "trinacria_regina",
                        "bacillariophytina", subphylum),
    class = if_else(latinname == "trinacria_regina",
                    "mediophyceae", class),
    subclass = if_else(latinname == "trinacria_regina",
                       "chaetocerotophycidae", subclass),
    order = if_else(latinname == "trinacria_regina",
                    "hemiaulales", order),
    family = if_else(latinname == "trinacria_regina",
                     "hemiaulaceae", family),
    genus = case_when(latinname == "trinacria_regina" ~ "trinacria",
                      latinname == "didymocystis" ~ "didymocystis",
                      latinname == "Lauterborniella_elegantissima" ~ "lauterborniella",
                      TRUE ~ genus),
    species = case_when(latinname == "trinacria_regina" ~ "trinacria_regina",
                        latinname == "lauterborniella_elegantissima" ~ "lauterborniella_elegantissima",
                        TRUE ~ species)
  )
```

Prepate Carbon Assignments
grab old carbon
```{r}
carbon.df <- readxl::read_excel(file.path(project.dir, "data/carbon/carbon_list_2014.xlsx"),
                                sheet = "carbon_list_2014") %>% 
  clean_up() %>% 
  
  #deselcting several fields
  dplyr::select(-dplyr::contains("new"),
                -smyayda_carbon,
                -difference,
                -shape_change) %>% 
  dplyr::rename(carbon = old_carbon)
```


this fills in 100 tsn with current data (760 missing to 660)
```{r}
bay_filled.df <- bay.df %>% 
  mutate(
    tsn = as.integer(tsn),
    tsn = case_when(
      latinname == "navicula_notablis" ~ as.integer(4327),
      latinname == "pleurosigma_macrum" ~ as.integer(4650),
      latinname == "pleurosigma_obscurum" ~ as.integer(591383),
      latinname == "polykrikos_hartmannii" ~ as.integer(331299),
      latinname == "protoperidinium_aciculiderum" ~ as.integer(10329),
      latinname == "protoperidinium_paulseni" ~ as.integer(3568),
      latinname == "scrippsiella_favionese" ~ as.integer(10537),
      latinname == "tetrastrum_caudatum" ~ as.integer(5691),
      latinname == "didymocystis" ~ as.integer(5810),
      latinname == "lauterborniella_elegantissima" ~ as.integer(6097),
      latinname == "characium_sp." ~ as.integer(5756),
      latinname == "cylindrospermopsis_sp." ~ as.integer(203689),
      latinname == "chaetoceros_neogracilis" ~ as.integer(1004011),
      latinname == "navicula_retusa_cancellata" ~ as.integer(1020372),
      latinname == "karlodinium_micrum" ~ as.integer(180904),
      latinname == "lagerheimia" ~ as.integer(6017),
      latinname == "quadricoccus_euryhalinicus" ~ as.integer(957939),
      latinname == "scrippsiella_precaria" ~ as.integer(10536),
      latinname == "psuedosolenia_calcar-avis" ~ as.integer(970064),
      latinname == "centronella" ~ as.integer(970064),
      latinname == "amphidinium_tatrae" ~ as.integer(9997),
      latinname == "navicula_lata" ~ as.integer(4450),
      latinname == "nitzschia_vitrea_recta" ~ as.integer(5204),
      latinname == "rhaphoneis_gemmifera" ~ as.integer(3145),
      latinname == "delphineis_surirella" ~ as.integer(969978),
      latinname == "navicula_annulata" ~ as.integer(3649),
      latinname == "proboscia_alata_gracillima" ~ as.integer(610099),
      latinname == "guinardia_striata" ~ as.integer(2921),
      latinname == "guinardia_cylindrus" ~ as.integer(2921),
      latinname == "aphanizomenon_issatschenkoi" ~ as.integer(1191),
      latinname == "helicotheca_tamesis" ~ as.integer(590815),
      latinname == "corethron_valdivae" ~ as.integer(2386),
      latinname == "gonyaulax_conjuncta" ~ as.integer(10359),
      latinname == "lioloma_delicatulum" ~ as.integer(573597),
      latinname == "syracosphaera_histrica" ~ as.integer(2234),
      latinname == "rhizosolenia_formosa" ~ as.integer(2879),
      latinname == "proboscla_alata_curvirostris" ~ as.integer(610099),
      latinname == "membraneis_challengeri" ~ as.integer(3648),
      latinname == "chrysococcus_tesselatus" ~ as.integer(1751),
      latinname == "rhoicosphenia_abbreviata" ~ as.integer(3633),
      latinname == "protoperidinium_aciculiferum" ~ as.integer(10340),
      latinname == "protoperidinium_fimbriatum" ~ as.integer(10340),
      latinname == "licmophora_inflata" ~ as.integer(3155),
      latinname == "biddulphia_reticulata" ~ as.integer(2678),
      latinname == "caloneis_lepidula" ~ as.integer(4369),
      latinname == "caloneis_trinodis" ~ as.integer(4369),
      latinname == "amphiprora_cholnokyi" ~ as.integer(4674),
      latinname == "navicula_interrupta" ~ as.integer(3649),
      latinname == "cerataulus_radiatus" ~ as.integer(2709),
      latinname == "gyrosigma_balticum_silimis" ~ as.integer(4623),
      latinname == "dictyocha_siderea" ~ as.integer(1804),
      latinname == "odontella_alternans" ~ as.integer(573604),
      latinname == "nitzschia_vitrea_salinarum" ~ as.integer(5204),
      latinname == "proboscla_alata_indica" ~ as.integer(610099),
      latinname == "attheya_decora" ~ as.integer(2876),
      latinname == "synedra_closterioides" ~ as.integer(970065),
      latinname == "trinacria_regina" ~ as.integer(2747),
      latinname == "chattonella" ~ as.integer(969917),
      latinname == "chattonella_subsalsa" ~ as.integer(969917),
      latinname == "heterosigma_akashiwo" ~ as.integer(969917),
      latinname == "vibrio_fisheri" ~ as.integer(959178),
      TRUE ~ as.integer(tsn)
    )
  )
```

```{r}
carbon.df <- carbon.df %>% 
  mutate(size = case_when(
    size %in% "unidentified" ~ as.character(NA),
    str_detect(size, "species|sp.") ~ str_replace_all(size, "sp.#|species_#|species_|species", "sp#"),
    TRUE ~size
  ),
  latinname = if_else(latinname == "blue_green_trichome", "blue_green_sphere", latinname)) %>% 
  mutate(picoplankton = if_else(
    diameter <= 20 &
      height <= 20 &
      width <= 20 &
      width <= 20 &
      height_2 <= 20 &
      width_2 <= 20,
    TRUE,
    FALSE
  )) %>% 
  select(latinname, size, carbon) %>%
  distinct() %>% 
  bind_rows(data.frame(latinname = "asterionellopsis_glacialis", 
                       carbon = carbon.df[carbon.df$latinname == "asterionellopsis_kariana", "carbon"],
                       stringsAsFactors = FALSE))
```

check for duplicate values
```{r}
carbon.dups <- carbon.df %>% 
  group_by(latinname, size) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  filter(count > 1)
```

excluding 3 types that have dups
```{r}
carbon.df <- carbon.df %>% 
  filter(!(latinname == "chaetoceros_wighami" & is.na(carbon)),
         !(latinname == "biddulphia" & carbon == 7899.50),
         !(latinname == "gymnodinium" & carbon == 848))
```

test that determines that Zach's code below is not needed (if dataframe is not empty Zach's code is needed, but my quess is that CEDR has been cleaned up since then and that the code shoul dnot be needed again)
```{r}
bay_test.df <- bay.df %>% 
  filter(
    size %in% c("not_applicable", "not_specified"),
    size == "cell-_small" & latinname == "gymnodinium",
    str_detect(size, "species|sp.") 
    
  )

#Zach's code.  can be commented back in if the above code returns a non empty dataframe
# bay.df <- bay.df %>% 
#   mutate(size = case_when(
#     size %in% c("not_applicable", "not_specified") ~ as.character(NA),
#     size == "cell-_small" & latinname == "gymnodinium" ~ as.character(NA),
#     str_detect(size, "species|sp.") ~ str_replace_all(size, "sp.#|species_#|species_|species", "sp#"),
#     TRUE ~ size
#   ))
```

(the following code is taken in full from Zach's code, decriptions included)

Identify all taxa (latinname) in bay.df that do not have a size equivalent in carbon.df.

```{r}
no.match.df <- anti_join(bay.df, carbon.df, by = c("latinname", "size")) %>% 
  select(latinname, size) %>% 
  distinct()
```

Attempt to find partial matches for taxa in no.match.df. Each row in no.match.df represents a unique taxon and size combination. lapply loops through each row, extracts the unique size string, splits the string into smaller pieces, and attempts to find partial matches with associated size strings in carbon.df. The string in carbon.df with the most partial matches will be used to replace the size string in bay.df.

```{r}
partial.match.df <- lapply(1:nrow(no.match.df), function(row.i) {
  sub.df <- no.match.df %>% 
    slice(row.i)
  
  size.vec <- str_split(sub.df$size, "_") %>% unlist()
  
  getmode <- function(v) {
    uniqv <- unique(v)
    uniqv[which.max(tabulate(match(v, uniqv)))]
  }
  
  
  carbon.sub <- carbon.df %>% 
    filter(latinname == sub.df$latinname) %>% 
    mutate(row_max_matches = sapply(size.vec, function(size.i) grep(size.i, size)) %>% 
             unlist() %>% 
             getmode()) %>% 
    slice(unique(row_max_matches)) %>% 
    select(-row_max_matches, -carbon) %>% 
    rename(new_size = size) %>% 
    mutate(size = sub.df$size)
  
  return(carbon.sub)
}) %>% 
  bind_rows()
```

Merge bay.df with partial.match.df and if a new_size is present from partial.match.df, then replace the size string with the new_size string. By updating the size strings it is possible to obtain more matches when merging bay.df and  carbon.df.
```{r}
bay_partials_added.df <- left_join(bay.df, partial.match.df, by = c("latinname", "size")) %>% 
  mutate(reported_size = size,
         size = if_else(!is.na(new_size), new_size, size))
```

Merge bay.df with carbon.df and calculate biomass. The phytoplankton counts are reported in picoliters. Biomass is converted to microliters.
```{r}
bay_merged.df <- left_join(bay_partials_added.df, carbon.df, by = c("latinname", "size")) %>% 
  mutate(micro_biomass = reportingvalue * carbon / 10 ^ 6)
```
(end of Zach's code)


test to see how many have missing info
note: missing tsn is 756, missing carbon is 9832
note: there are 24 without carbon values in carbon.df
```{r}
missing_tsn.df <- bay_merged.df %>%
  filter(is.na(tsn) | tsn == 0)

missing_carbon.df <- bay_merged.df %>%
  filter(is.na(carbon) | carbon == 0)
```


```{r}
# missing_carbon.df <- carbon.df %>%
#   filter(is.na(carbon) | carbon == 0)
```









######################## END

match taxa with the carbon value(carbon conversion factor)
```{r}
bay_filled.df <- bay_filled.df%>%
  mutate(tsn=as.character(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))

carbon.df <- carbon.df %>%
  mutate(tsn=as.character(tsn)) 

matched.df <- left_join(bay_filled.df, carbon.df, by = c("latinname", "size"))#"tsn")#c("latinname","tsn", "size"))
```

testing
```{r}
carbon_test.df <- carbon.df %>%
  rename(sampledate = r_date) %>%
  mutate(sampledate = as.Date(sampledate))

match_test.df <- left_join(bay_filled.df, carbon_test.df, by = c("sampledate"))#, "tsn", "latinname", "size"))
```

random test 
```{r}
test.df <- bay.df %>%
  filter(tsn == 0)

test.df <- carbon.df %>%
  filter(tsn == 0)
```



test to see how many have missing info
note: the tsn's do not seem to match up between phyto taxa and jackie's carbon
```{r}
missing_tsn.df <- match_test.df %>%
  filter(is.na(tsn) | tsn == 0)

missing_carbon.df <- match_test.df %>%
  filter(is.na(carbon) | carbon == 0)
```





















extracting depth integrated dataframe for each parameter
note:doc has 560, and salinity 1585 items where all others have 666
this is another way of doing
STEP 7
```{r}
# di_doc.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter=="doc") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_doc = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()
# 
# di_chla.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter == "chla") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_chla = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()
# 
# di_salinity.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter == "salinity") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_salinity = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()
# 
# di_pheo.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter == "pheo") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_pheo = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()

#step7 <- left_join(di_doc.df, di_chla.df, di_salinity.df, di_pheo.df, by = c("station", "sampledate"))

#join the four dataframes created above into one dataframe

# wq_all.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df))
```

C-  need to apply this to all sample, date combos but want to review with Claire first
```{r}
# di_salinity.df <-di_salinity.df %>%
# 
#   mutate(salzone = case_when(
#     avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
#     avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
#     avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
#     avg_di_salinity > 18~ "P")
#   )
```

```{r}
#wq_joined.df <- left_join(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df, by = c("station", "sampledate"))
wq_all.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df))#, s_chla.df))

di_wq_all.df <- wq_all.df %>%
  filter(above_pdepth == TRUE) #depth <= pdepth) 
```



assign salzones

```{r}
wq_all.df <- wq_all.df %>%
  mutate(salzone = case_when(
    avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
    avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
    avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
    avg_di_salinity > 18~ "P"))
```


```{r}
# wq_sz.df <- wq_all.df %>%
#   select(station, sampledate, salzone) %>%
#   distinct() %>%
#   filter(!is.na(salzone))
```

```{r}
# sal.df <- wq_all.df %>%
#   group_by(station, sampledate) %>%
#   mutate(apple= case_when(parameter == "salinity"~avg_di_salinity, 
#                           parameter %in% c("pheo", "doc", "chla")~0)
#          ) %>%
#   summarise(apple = max(apple)) %>%
#   ungroup() 
# 
# wq_sal.df <- left_join(wq_all.df, sal.df, by = c("station", "sampledate"))
```

generate dataframe...
```{r}
sal.df <- wq_all.df %>%
  mutate(avg_di_salinity= case_when(parameter %in% c("pheo", "doc", "chla")~0, TRUE~avg_di_salinity)
         ) %>%
  filter(!is.na(avg_di_salinity))

sal.df <- sal.df %>%
  group_by(station, sampledate) %>%
  summarise(avg_di_salinity = max(avg_di_salinity)) %>%
  ungroup() 
```


```{r}
wq_all.temp<- wq_all.df %>%
  select(-avg_di_salinity)

#wq_all_test.df < left_join(wq_all.temp, sal.df, by = c("station", "sampledate"))
wq_all_test.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(wq_all.temp, sal.df))
  
```

assign salzones
```{r}
wq_sal.df <-wq_all_test.df %>%

  mutate(salzone = case_when(
    avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
    avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
    avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
    avg_di_salinity > 18~ "P")
  )
```


###Taxanmoic data (ITIS)

this is Zach's code.  It's pretty neat.
```{r}
col.class.vec <- c("samplenumber" = "character",
                   "tsn" = "character",
                   "speccode" = "character",
                   "reportingvalue" = "integer")

bay.temp <- data.table::fread(file.path(project.dir,  "data/CEDR/cedr_phyto_taxa.csv"
                                        #"data/phytoplankton2/VA_ODU_phyto_taxa.csv"
                                        ),
                            data.table = FALSE,
                            colClasses = col.class.vec)
```

this test shows that 1794 have a tsn of 0(Zach explains there are no na, only 0, which is annoying)
```{r}
need_tsn.df <- bay.temp %>%
  filter(tsn==0)
```

tsn assignment code(reduces number of tsn not assinged to 1514 from 1794)
```{r}
taxa.df <- bay.temp %>% 
  mutate(
    tsn = as.integer(tsn),
    tsn = case_when(
      latinname == "navicula_notablis" ~ as.integer(4327),
      latinname == "pleurosigma_macrum" ~ as.integer(4650),
      latinname == "pleurosigma_obscurum" ~ as.integer(591383),
      latinname == "polykrikos_hartmannii" ~ as.integer(331299),
      latinname == "protoperidinium_aciculiderum" ~ as.integer(10329),
      latinname == "protoperidinium_paulseni" ~ as.integer(3568),
      latinname == "scrippsiella_favionese" ~ as.integer(10537),
      latinname == "tetrastrum_caudatum" ~ as.integer(5691),
      latinname == "didymocystis" ~ as.integer(5810),
      latinname == "lauterborniella_elegantissima" ~ as.integer(6097),
      latinname == "characium_sp." ~ as.integer(5756),
      latinname == "cylindrospermopsis_sp." ~ as.integer(203689),
      latinname == "chaetoceros_neogracilis" ~ as.integer(1004011),
      latinname == "navicula_retusa_cancellata" ~ as.integer(1020372),
      latinname == "karlodinium_micrum" ~ as.integer(180904),
      latinname == "lagerheimia" ~ as.integer(6017),
      latinname == "quadricoccus_euryhalinicus" ~ as.integer(957939),
      latinname == "scrippsiella_precaria" ~ as.integer(10536),
      latinname == "psuedosolenia_calcar-avis" ~ as.integer(970064),
      latinname == "centronella" ~ as.integer(970064),
      latinname == "amphidinium_tatrae" ~ as.integer(9997),
      latinname == "navicula_lata" ~ as.integer(4450),
      latinname == "nitzschia_vitrea_recta" ~ as.integer(5204),
      latinname == "rhaphoneis_gemmifera" ~ as.integer(3145),
      latinname == "delphineis_surirella" ~ as.integer(969978),
      latinname == "navicula_annulata" ~ as.integer(3649),
      latinname == "proboscia_alata_gracillima" ~ as.integer(610099),
      latinname == "guinardia_striata" ~ as.integer(2921),
      latinname == "guinardia_cylindrus" ~ as.integer(2921),
      latinname == "aphanizomenon_issatschenkoi" ~ as.integer(1191),
      latinname == "helicotheca_tamesis" ~ as.integer(590815),
      latinname == "corethron_valdivae" ~ as.integer(2386),
      latinname == "gonyaulax_conjuncta" ~ as.integer(10359),
      latinname == "lioloma_delicatulum" ~ as.integer(573597),
      latinname == "syracosphaera_histrica" ~ as.integer(2234),
      latinname == "rhizosolenia_formosa" ~ as.integer(2879),
      latinname == "proboscla_alata_curvirostris" ~ as.integer(610099),
      latinname == "membraneis_challengeri" ~ as.integer(3648),
      latinname == "chrysococcus_tesselatus" ~ as.integer(1751),
      latinname == "rhoicosphenia_abbreviata" ~ as.integer(3633),
      latinname == "protoperidinium_aciculiferum" ~ as.integer(10340),
      latinname == "protoperidinium_fimbriatum" ~ as.integer(10340),
      latinname == "licmophora_inflata" ~ as.integer(3155),
      latinname == "biddulphia_reticulata" ~ as.integer(2678),
      latinname == "caloneis_lepidula" ~ as.integer(4369),
      latinname == "caloneis_trinodis" ~ as.integer(4369),
      latinname == "amphiprora_cholnokyi" ~ as.integer(4674),
      latinname == "navicula_interrupta" ~ as.integer(3649),
      latinname == "cerataulus_radiatus" ~ as.integer(2709),
      latinname == "gyrosigma_balticum_silimis" ~ as.integer(4623),
      latinname == "dictyocha_siderea" ~ as.integer(1804),
      latinname == "odontella_alternans" ~ as.integer(573604),
      latinname == "nitzschia_vitrea_salinarum" ~ as.integer(5204),
      latinname == "proboscla_alata_indica" ~ as.integer(610099),
      latinname == "attheya_decora" ~ as.integer(2876),
      latinname == "synedra_closterioides" ~ as.integer(970065),
      latinname == "trinacria_regina" ~ as.integer(2747),
      latinname == "chattonella" ~ as.integer(969917),
      latinname == "chattonella_subsalsa" ~ as.integer(969917),
      latinname == "heterosigma_akashiwo" ~ as.integer(969917),
      latinname == "vibrio_fisheri" ~ as.integer(959178),
      TRUE ~ as.integer(tsn)
    )
  )
```

```{r}
taxa_need_tsn.df <- taxa.df %>%
  filter(tsn==0)
``` 

changed all org_tsn references to tsn, because org_tsn does not exist in bay.temp.
Also, first row is na's and 0's suggesting that the data has a space between the header, and that total number of
ojects(3065) may be one over our actual values
```{r}
hier.wide <- lapply(unique(bay.temp$tsn), function(tsn.i) {
 #print(tsn.i)
  
  if(ncol(usage(tsn.i)) == 0) return(data.frame(tsn = as.integer(tsn.i),
                                                stringsAsFactors = FALSE))
  if(!ritis::usage(tsn.i)$taxonUsageRating %in% c("accepted", "valid")) {
    tsn.accepted <- ritis::accepted_names(as.integer(tsn.i))$acceptedTsn
  } else {
    tsn.accepted <- as.integer(tsn.i)
  }

  full.df <- ritis::hierarchy_full(tsn.accepted) %>%
    select(rankname, taxonname, tsn) %>%
    slice(1:which(tsn == tsn.accepted)) %>%
    mutate(tsn = as.integer(tsn.i),
           final_tsn = as.integer(tsn.accepted),
           final_id = slice(., which(tsn == tsn.accepted))$taxonname)
}
) %>%
  bind_rows() %>%
#   select(-tsn) %>% 
  #spread(rankname, taxonname) %>%
  clean_up()
```

removes the gap mentioned above
```{r}
hier.wide<- hier.wide %>%
  filter(!is.na(taxonname) & !is.na(rankname))
```

```{r}
column.vec <- c("org_tsn", "final_tsn", "final_id",
                "kingdom", "subkingdom", "infrakingdom", 
                "superdivision", "division", "subdivision", "infradivision",
                "superphylum", "phylum", "subphylum", "infraphylum", 
                "superclass", "class", "subclass", "infraclass", 
                "superorder", "order", "suborder", "infraorder", 
                "superfamily", "family", "subfamily", 
                "tribe", "subtribe", 
                "genus", "subgenus", 
                "species", "subspecies")

column.vec <- column.vec[column.vec %in% names(hier.wide)]
```

save the itis data to a csv
```{r}


data.table::fwrite(hier.wide, file.path(rprojroot::find_rstudio_root_file(), "data/itis", "itis_hierarchy.csv"))
```


####Testing
```{r}
# na <- stat_samp %>%
#   filter(is.na(stat_samp$pdepth))
# 
# not_na <- stat_samp %>%
#   filter(!is.na(stat_samp$pdepth))

# pico.df <- file.path(url.root,
#                       "LivingResources",
#                       "TidalPlankton",
#                       "Reported",
#                        min_date,
#                        # "1-1-2013",
#                        max_date, 
#                        # "12-31-2016",
#                       #"Picoplankton",
#                        "18",
#                       "Station",
#                       paste(station.vec, collapse = ",")) %>%
#   fromJSON() %>% 
#   clean_up()
# 
# stat <- pico_test.df %>%
#   select(station) %>%
#   distinct()

# no_p.df<- pdepth.df %>%
#   filter(!station%in%c("tf3.3","tf4.2","tf5.5","ret3.1","ret4.3","ret3.1") & is.na(pdepth) & layer %in% c("ap", "wc"))


            

```


```{r}
test <-  lapply(unique(bay.temp$tsn), function(placeholder)
  {
  if(ncol(usage(placeholder))== 0) return(data.frame(tsn = as.integer(placeholder),
                                                stringsAsFactors = FALSE))
  if(!ritis::usage(placeholder)$taxonUsageRating %in% c("accepted", "valid")) {
  tsn.accepted <- ritis::accepted_names(as.integer(placeholder))$acceptedTsn
    #test <- mutate(test="worked"
  } else {
    tsn.accepted <- as.integer(placeholder)
  }
  

  })
#rm(test)
```
---
title: "pibi_long"
author: "Luke Vawter"
date: "December 21, 2018"
output: 
  html_document:
    df_print: pagde
    toc: yes
    toc_depth: '6'
    toc_float: yes
---




Taxanomic steps
currently using Zach's code mostly unmodified at this point(change as needed)

update TSNs

```{r}
# col.class.vec <- c("samplenumber" = "character",
#                    "tsn" = "character",
#                    "reportingvalue" = "integer")
# 
# bay.temp <- data.table::fread(file.path(project.dir,  "data/CEDR/cedr_phyto_taxa.csv"
#                                         #"data/phytoplankton2/VA_ODU_phyto_taxa.csv"
#                                         ),
#                             data.table = FALSE,
#                             colClasses = col.class.vec)
```

```{r}
bay.df <- phyto.df %>% 
  filter(layer %in% c("ap", "wc")) %>% 
  distinct() %>% 
  mutate(month = month(sampledate),
         season = case_when(
           month %in% c(3, 4, 5) ~ "spring",
           month %in% c(7, 8, 9) ~ "summer",
           TRUE ~ "remove"
         )) %>% 
  filter(season %in% c("spring", "summer")) %>%
  #changing types to match as is done in Zach's code using col.class.vec
  mutate(tsn=as.character(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))
  
```


If there are multiple taxa with the same taxonomic name, then the reporting values should be summed. Each row should represent a unique taxon.
```{r}
bay.df <- bay.df %>% 
  group_by_at(vars(-reportingvalue)) %>% 
  summarize(reportingvalue = sum(reportingvalue)) %>% 
  ungroup()
```


```{r}
bay.df <- bay.df %>% 
  filter(grepl("ph", method),
         !latinname %in% c("micro-phytoflagellates",
                           "microflagellates",
                           #"green_cells",
                           #"blue_green_sphere",
                           "epiphytic_flagellates",
                           "hydrodictyon_reticulatum"))
```

Taxaonmic Hierarchy
```{r}
hier.wide <- data.table::fread(file.path(project.dir, "data/itis/itis_hierarchy.csv"),
                            data.table = FALSE,
                            na.strings = "") %>% 
  clean_up() %>%
  mutate(tsn=as.character(tsn))
```

Z. The taxonomic counts are joined with the taxonomic hierarchy data by the final_tsn columns. A unique identifier (unique_id) is created for each sampling event by concatenating station, layer, samplenumber, and sampledate.
```{r}
bay.df <- left_join(bay.df, hier.wide, by = "tsn") %>% 
  mutate(unique_id = paste(station, layer, samplenumber, sampledate, sep = "_"))
```

Z. Some taxa require specific attention before they can be finalized.
```{r}
bay.df <- bay.df %>% 
  mutate(
    final_id = if_else(latinname == "trinacria_regina", "trinacria_regina",  final_id),
    final_id = case_when(
      latinname == "green_cells" ~ "green_cells",
      latinname == "blue_green_spheres" ~ "blue_green_spheres",
      TRUE ~ final_id
    ),
    kingdom = if_else(latinname == "trinacria_regina",
                      "chromista", kingdom),
    phylum = if_else(latinname == "trinacria_regina",
                     "bacillariophyta", phylum),
    subphylum = if_else(latinname == "trinacria_regina",
                        "bacillariophytina", subphylum),
    class = if_else(latinname == "trinacria_regina",
                    "mediophyceae", class),
    subclass = if_else(latinname == "trinacria_regina",
                       "chaetocerotophycidae", subclass),
    order = if_else(latinname == "trinacria_regina",
                    "hemiaulales", order),
    family = if_else(latinname == "trinacria_regina",
                     "hemiaulaceae", family),
    genus = case_when(latinname == "trinacria_regina" ~ "trinacria",
                      latinname == "didymocystis" ~ "didymocystis",
                      latinname == "Lauterborniella_elegantissima" ~ "lauterborniella",
                      TRUE ~ genus),
    species = case_when(latinname == "trinacria_regina" ~ "trinacria_regina",
                        latinname == "lauterborniella_elegantissima" ~ "lauterborniella_elegantissima",
                        TRUE ~ species)
  )
```

Prepate Carbon Assignments
grab old carbon
```{r}
carbon.df <- readxl::read_excel(file.path(project.dir, "data/carbon/carbon_list_2014.xlsx"),
                                sheet = "carbon_list_2014") %>% 
  clean_up() %>% 
  
  #deselcting several fields
  dplyr::select(-dplyr::contains("new"),
                -smyayda_carbon,
                -difference,
                -shape_change) %>% 
  dplyr::rename(carbon = old_carbon)
```


this fills in 100 tsn with current data (760 missing to 660)
```{r}
bay_filled.df <- bay.df %>% 
  mutate(
    tsn = as.integer(tsn),
    tsn = case_when(
      latinname == "navicula_notablis" ~ as.integer(4327),
      latinname == "pleurosigma_macrum" ~ as.integer(4650),
      latinname == "pleurosigma_obscurum" ~ as.integer(591383),
      latinname == "polykrikos_hartmannii" ~ as.integer(331299),
      latinname == "protoperidinium_aciculiderum" ~ as.integer(10329),
      latinname == "protoperidinium_paulseni" ~ as.integer(3568),
      latinname == "scrippsiella_favionese" ~ as.integer(10537),
      latinname == "tetrastrum_caudatum" ~ as.integer(5691),
      latinname == "didymocystis" ~ as.integer(5810),
      latinname == "lauterborniella_elegantissima" ~ as.integer(6097),
      latinname == "characium_sp." ~ as.integer(5756),
      latinname == "cylindrospermopsis_sp." ~ as.integer(203689),
      latinname == "chaetoceros_neogracilis" ~ as.integer(1004011),
      latinname == "navicula_retusa_cancellata" ~ as.integer(1020372),
      latinname == "karlodinium_micrum" ~ as.integer(180904),
      latinname == "lagerheimia" ~ as.integer(6017),
      latinname == "quadricoccus_euryhalinicus" ~ as.integer(957939),
      latinname == "scrippsiella_precaria" ~ as.integer(10536),
      latinname == "psuedosolenia_calcar-avis" ~ as.integer(970064),
      latinname == "centronella" ~ as.integer(970064),
      latinname == "amphidinium_tatrae" ~ as.integer(9997),
      latinname == "navicula_lata" ~ as.integer(4450),
      latinname == "nitzschia_vitrea_recta" ~ as.integer(5204),
      latinname == "rhaphoneis_gemmifera" ~ as.integer(3145),
      latinname == "delphineis_surirella" ~ as.integer(969978),
      latinname == "navicula_annulata" ~ as.integer(3649),
      latinname == "proboscia_alata_gracillima" ~ as.integer(610099),
      latinname == "guinardia_striata" ~ as.integer(2921),
      latinname == "guinardia_cylindrus" ~ as.integer(2921),
      latinname == "aphanizomenon_issatschenkoi" ~ as.integer(1191),
      latinname == "helicotheca_tamesis" ~ as.integer(590815),
      latinname == "corethron_valdivae" ~ as.integer(2386),
      latinname == "gonyaulax_conjuncta" ~ as.integer(10359),
      latinname == "lioloma_delicatulum" ~ as.integer(573597),
      latinname == "syracosphaera_histrica" ~ as.integer(2234),
      latinname == "rhizosolenia_formosa" ~ as.integer(2879),
      latinname == "proboscla_alata_curvirostris" ~ as.integer(610099),
      latinname == "membraneis_challengeri" ~ as.integer(3648),
      latinname == "chrysococcus_tesselatus" ~ as.integer(1751),
      latinname == "rhoicosphenia_abbreviata" ~ as.integer(3633),
      latinname == "protoperidinium_aciculiferum" ~ as.integer(10340),
      latinname == "protoperidinium_fimbriatum" ~ as.integer(10340),
      latinname == "licmophora_inflata" ~ as.integer(3155),
      latinname == "biddulphia_reticulata" ~ as.integer(2678),
      latinname == "caloneis_lepidula" ~ as.integer(4369),
      latinname == "caloneis_trinodis" ~ as.integer(4369),
      latinname == "amphiprora_cholnokyi" ~ as.integer(4674),
      latinname == "navicula_interrupta" ~ as.integer(3649),
      latinname == "cerataulus_radiatus" ~ as.integer(2709),
      latinname == "gyrosigma_balticum_silimis" ~ as.integer(4623),
      latinname == "dictyocha_siderea" ~ as.integer(1804),
      latinname == "odontella_alternans" ~ as.integer(573604),
      latinname == "nitzschia_vitrea_salinarum" ~ as.integer(5204),
      latinname == "proboscla_alata_indica" ~ as.integer(610099),
      latinname == "attheya_decora" ~ as.integer(2876),
      latinname == "synedra_closterioides" ~ as.integer(970065),
      latinname == "trinacria_regina" ~ as.integer(2747),
      latinname == "chattonella" ~ as.integer(969917),
      latinname == "chattonella_subsalsa" ~ as.integer(969917),
      latinname == "heterosigma_akashiwo" ~ as.integer(969917),
      latinname == "vibrio_fisheri" ~ as.integer(959178),
      TRUE ~ as.integer(tsn)
    )
  )
```

```{r}
carbon.df <- carbon.df %>% 
  mutate(size = case_when(
    size %in% "unidentified" ~ as.character(NA),
    str_detect(size, "species|sp.") ~ str_replace_all(size, "sp.#|species_#|species_|species", "sp#"),
    TRUE ~size
  ),
  latinname = if_else(latinname == "blue_green_trichome", "blue_green_sphere", latinname)) %>% 
  mutate(picoplankton = if_else(
    diameter <= 20 &
      height <= 20 &
      width <= 20 &
      width <= 20 &
      height_2 <= 20 &
      width_2 <= 20,
    TRUE,
    FALSE
  )) %>% 
  select(latinname, size, carbon) %>%
  distinct() %>% 
  bind_rows(data.frame(latinname = "asterionellopsis_glacialis", 
                       carbon = carbon.df[carbon.df$latinname == "asterionellopsis_kariana", "carbon"],
                       stringsAsFactors = FALSE))
```

check for duplicate values
```{r}
carbon.dups <- carbon.df %>% 
  group_by(latinname, size) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  filter(count > 1)
```

excluding 3 types that have dups
```{r}
carbon.df <- carbon.df %>% 
  filter(!(latinname == "chaetoceros_wighami" & is.na(carbon)),
         !(latinname == "biddulphia" & carbon == 7899.50),
         !(latinname == "gymnodinium" & carbon == 848))
```

test that determines that Zach's code below is not needed (if dataframe is not empty Zach's code is needed, but my quess is that CEDR has been cleaned up since then and that the code shoul dnot be needed again)
```{r}
bay_test.df <- bay.df %>% 
  filter(
    size %in% c("not_applicable", "not_specified"),
    size == "cell-_small" & latinname == "gymnodinium",
    str_detect(size, "species|sp.") 
    
  )

#Zach's code.  can be commented back in if the above code returns a non empty dataframe
# bay.df <- bay.df %>% 
#   mutate(size = case_when(
#     size %in% c("not_applicable", "not_specified") ~ as.character(NA),
#     size == "cell-_small" & latinname == "gymnodinium" ~ as.character(NA),
#     str_detect(size, "species|sp.") ~ str_replace_all(size, "sp.#|species_#|species_|species", "sp#"),
#     TRUE ~ size
#   ))
```

(the following code is taken in full from Zach's code, decriptions included)

Identify all taxa (latinname) in bay.df that do not have a size equivalent in carbon.df.

```{r}
no.match.df <- anti_join(bay.df, carbon.df, by = c("latinname", "size")) %>% 
  select(latinname, size) %>% 
  distinct()
```

Attempt to find partial matches for taxa in no.match.df. Each row in no.match.df represents a unique taxon and size combination. lapply loops through each row, extracts the unique size string, splits the string into smaller pieces, and attempts to find partial matches with associated size strings in carbon.df. The string in carbon.df with the most partial matches will be used to replace the size string in bay.df.

```{r}
partial.match.df <- lapply(1:nrow(no.match.df), function(row.i) {
  sub.df <- no.match.df %>% 
    slice(row.i)
  
  size.vec <- str_split(sub.df$size, "_") %>% unlist()
  
  getmode <- function(v) {
    uniqv <- unique(v)
    uniqv[which.max(tabulate(match(v, uniqv)))]
  }
  
  
  carbon.sub <- carbon.df %>% 
    filter(latinname == sub.df$latinname) %>% 
    mutate(row_max_matches = sapply(size.vec, function(size.i) grep(size.i, size)) %>% 
             unlist() %>% 
             getmode()) %>% 
    slice(unique(row_max_matches)) %>% 
    select(-row_max_matches, -carbon) %>% 
    rename(new_size = size) %>% 
    mutate(size = sub.df$size)
  
  return(carbon.sub)
}) %>% 
  bind_rows()
```

Merge bay.df with partial.match.df and if a new_size is present from partial.match.df, then replace the size string with the new_size string. By updating the size strings it is possible to obtain more matches when merging bay.df and  carbon.df.
```{r}
bay_partials_added.df <- left_join(bay.df, partial.match.df, by = c("latinname", "size")) %>% 
  mutate(reported_size = size,
         size = if_else(!is.na(new_size), new_size, size))
```

Merge bay.df with carbon.df and calculate biomass. The phytoplankton counts are reported in picoliters. Biomass is converted to microliters.
```{r}
bay_merged.df <- left_join(bay_partials_added.df, carbon.df, by = c("latinname", "size")) %>% 
  mutate(micro_biomass = reportingvalue * carbon / 10 ^ 6)
```
(end of Zach's code)


test to see how many have missing info
note: missing tsn is 756, missing carbon is 9832
note: there are 24 without carbon values in carbon.df
```{r}
missing_tsn.df <- bay_merged.df %>%
  filter(is.na(tsn) | tsn == 0)

missing_carbon.df <- bay_merged.df %>%
  filter(is.na(carbon) | carbon == 0)
```


```{r}
# missing_carbon.df <- carbon.df %>%
#   filter(is.na(carbon) | carbon == 0)
```









######################## END

match taxa with the carbon value(carbon conversion factor)
```{r}
bay_filled.df <- bay_filled.df%>%
  mutate(tsn=as.character(tsn)) %>%
  mutate(speccode = as.character(speccode)) %>%
  mutate(reportingvalue = as.integer(reportingvalue)) %>%
  mutate(samplenumber = as.character(samplenumber))

carbon.df <- carbon.df %>%
  mutate(tsn=as.character(tsn)) 

matched.df <- left_join(bay_filled.df, carbon.df, by = c("latinname", "size"))#"tsn")#c("latinname","tsn", "size"))
```

testing
```{r}
carbon_test.df <- carbon.df %>%
  rename(sampledate = r_date) %>%
  mutate(sampledate = as.Date(sampledate))

match_test.df <- left_join(bay_filled.df, carbon_test.df, by = c("sampledate"))#, "tsn", "latinname", "size"))
```

random test 
```{r}
test.df <- bay.df %>%
  filter(tsn == 0)

test.df <- carbon.df %>%
  filter(tsn == 0)
```



test to see how many have missing info
note: the tsn's do not seem to match up between phyto taxa and jackie's carbon
```{r}
missing_tsn.df <- match_test.df %>%
  filter(is.na(tsn) | tsn == 0)

missing_carbon.df <- match_test.df %>%
  filter(is.na(carbon) | carbon == 0)
```





















extracting depth integrated dataframe for each parameter
note:doc has 560, and salinity 1585 items where all others have 666
this is another way of doing
STEP 7
```{r}
# di_doc.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter=="doc") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_doc = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()
# 
# di_chla.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter == "chla") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_chla = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()
# 
# di_salinity.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter == "salinity") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_salinity = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()
# 
# di_pheo.df <- wq_above_pdepth.df %>%
#   #filter(depth <= pdepth) %>%
#   filter(parameter == "pheo") %>%
# 
#   group_by(station, sampledate) %>%
#   mutate(avg_di_pheo = mean(measurevalue_averaged, na.rm = TRUE)) %>%
#   ungroup()

#step7 <- left_join(di_doc.df, di_chla.df, di_salinity.df, di_pheo.df, by = c("station", "sampledate"))

#join the four dataframes created above into one dataframe

# wq_all.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df))
```

C-  need to apply this to all sample, date combos but want to review with Claire first
```{r}
# di_salinity.df <-di_salinity.df %>%
# 
#   mutate(salzone = case_when(
#     avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
#     avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
#     avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
#     avg_di_salinity > 18~ "P")
#   )
```

```{r}
#wq_joined.df <- left_join(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df, by = c("station", "sampledate"))
wq_all.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(di_doc.df, di_chla.df,di_salinity.df,di_pheo.df))#, s_chla.df))

di_wq_all.df <- wq_all.df %>%
  filter(above_pdepth == TRUE) #depth <= pdepth) 
```



assign salzones

```{r}
wq_all.df <- wq_all.df %>%
  mutate(salzone = case_when(
    avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
    avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
    avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
    avg_di_salinity > 18~ "P"))
```


```{r}
# wq_sz.df <- wq_all.df %>%
#   select(station, sampledate, salzone) %>%
#   distinct() %>%
#   filter(!is.na(salzone))
```

```{r}
# sal.df <- wq_all.df %>%
#   group_by(station, sampledate) %>%
#   mutate(apple= case_when(parameter == "salinity"~avg_di_salinity, 
#                           parameter %in% c("pheo", "doc", "chla")~0)
#          ) %>%
#   summarise(apple = max(apple)) %>%
#   ungroup() 
# 
# wq_sal.df <- left_join(wq_all.df, sal.df, by = c("station", "sampledate"))
```

generate dataframe...
```{r}
sal.df <- wq_all.df %>%
  mutate(avg_di_salinity= case_when(parameter %in% c("pheo", "doc", "chla")~0, TRUE~avg_di_salinity)
         ) %>%
  filter(!is.na(avg_di_salinity))

sal.df <- sal.df %>%
  group_by(station, sampledate) %>%
  summarise(avg_di_salinity = max(avg_di_salinity)) %>%
  ungroup() 
```


```{r}
wq_all.temp<- wq_all.df %>%
  select(-avg_di_salinity)

#wq_all_test.df < left_join(wq_all.temp, sal.df, by = c("station", "sampledate"))
wq_all_test.df <- Reduce(function(x, y) merge(x, y, all=TRUE), list(wq_all.temp, sal.df))
  
```

assign salzones
```{r}
wq_sal.df <-wq_all_test.df %>%

  mutate(salzone = case_when(
    avg_di_salinity >0 & avg_di_salinity <= 0.5 ~ "F",
    avg_di_salinity > .5 &  avg_di_salinity <= 5 ~ "O",
    avg_di_salinity > 5 & avg_di_salinity <= 18 ~ "M",
    avg_di_salinity > 18~ "P")
  )
```


###Taxanmoic data (ITIS)

this is Zach's code.  It's pretty neat.
```{r}
col.class.vec <- c("samplenumber" = "character",
                   "tsn" = "character",
                   "speccode" = "character",
                   "reportingvalue" = "integer")

bay.temp <- data.table::fread(file.path(project.dir,  "data/CEDR/cedr_phyto_taxa.csv"
                                        #"data/phytoplankton2/VA_ODU_phyto_taxa.csv"
                                        ),
                            data.table = FALSE,
                            colClasses = col.class.vec)
```

this test shows that 1794 have a tsn of 0(Zach explains there are no na, only 0, which is annoying)
```{r}
need_tsn.df <- bay.temp %>%
  filter(tsn==0)
```

tsn assignment code(reduces number of tsn not assinged to 1514 from 1794)
```{r}
taxa.df <- bay.temp %>% 
  mutate(
    tsn = as.integer(tsn),
    tsn = case_when(
      latinname == "navicula_notablis" ~ as.integer(4327),
      latinname == "pleurosigma_macrum" ~ as.integer(4650),
      latinname == "pleurosigma_obscurum" ~ as.integer(591383),
      latinname == "polykrikos_hartmannii" ~ as.integer(331299),
      latinname == "protoperidinium_aciculiderum" ~ as.integer(10329),
      latinname == "protoperidinium_paulseni" ~ as.integer(3568),
      latinname == "scrippsiella_favionese" ~ as.integer(10537),
      latinname == "tetrastrum_caudatum" ~ as.integer(5691),
      latinname == "didymocystis" ~ as.integer(5810),
      latinname == "lauterborniella_elegantissima" ~ as.integer(6097),
      latinname == "characium_sp." ~ as.integer(5756),
      latinname == "cylindrospermopsis_sp." ~ as.integer(203689),
      latinname == "chaetoceros_neogracilis" ~ as.integer(1004011),
      latinname == "navicula_retusa_cancellata" ~ as.integer(1020372),
      latinname == "karlodinium_micrum" ~ as.integer(180904),
      latinname == "lagerheimia" ~ as.integer(6017),
      latinname == "quadricoccus_euryhalinicus" ~ as.integer(957939),
      latinname == "scrippsiella_precaria" ~ as.integer(10536),
      latinname == "psuedosolenia_calcar-avis" ~ as.integer(970064),
      latinname == "centronella" ~ as.integer(970064),
      latinname == "amphidinium_tatrae" ~ as.integer(9997),
      latinname == "navicula_lata" ~ as.integer(4450),
      latinname == "nitzschia_vitrea_recta" ~ as.integer(5204),
      latinname == "rhaphoneis_gemmifera" ~ as.integer(3145),
      latinname == "delphineis_surirella" ~ as.integer(969978),
      latinname == "navicula_annulata" ~ as.integer(3649),
      latinname == "proboscia_alata_gracillima" ~ as.integer(610099),
      latinname == "guinardia_striata" ~ as.integer(2921),
      latinname == "guinardia_cylindrus" ~ as.integer(2921),
      latinname == "aphanizomenon_issatschenkoi" ~ as.integer(1191),
      latinname == "helicotheca_tamesis" ~ as.integer(590815),
      latinname == "corethron_valdivae" ~ as.integer(2386),
      latinname == "gonyaulax_conjuncta" ~ as.integer(10359),
      latinname == "lioloma_delicatulum" ~ as.integer(573597),
      latinname == "syracosphaera_histrica" ~ as.integer(2234),
      latinname == "rhizosolenia_formosa" ~ as.integer(2879),
      latinname == "proboscla_alata_curvirostris" ~ as.integer(610099),
      latinname == "membraneis_challengeri" ~ as.integer(3648),
      latinname == "chrysococcus_tesselatus" ~ as.integer(1751),
      latinname == "rhoicosphenia_abbreviata" ~ as.integer(3633),
      latinname == "protoperidinium_aciculiferum" ~ as.integer(10340),
      latinname == "protoperidinium_fimbriatum" ~ as.integer(10340),
      latinname == "licmophora_inflata" ~ as.integer(3155),
      latinname == "biddulphia_reticulata" ~ as.integer(2678),
      latinname == "caloneis_lepidula" ~ as.integer(4369),
      latinname == "caloneis_trinodis" ~ as.integer(4369),
      latinname == "amphiprora_cholnokyi" ~ as.integer(4674),
      latinname == "navicula_interrupta" ~ as.integer(3649),
      latinname == "cerataulus_radiatus" ~ as.integer(2709),
      latinname == "gyrosigma_balticum_silimis" ~ as.integer(4623),
      latinname == "dictyocha_siderea" ~ as.integer(1804),
      latinname == "odontella_alternans" ~ as.integer(573604),
      latinname == "nitzschia_vitrea_salinarum" ~ as.integer(5204),
      latinname == "proboscla_alata_indica" ~ as.integer(610099),
      latinname == "attheya_decora" ~ as.integer(2876),
      latinname == "synedra_closterioides" ~ as.integer(970065),
      latinname == "trinacria_regina" ~ as.integer(2747),
      latinname == "chattonella" ~ as.integer(969917),
      latinname == "chattonella_subsalsa" ~ as.integer(969917),
      latinname == "heterosigma_akashiwo" ~ as.integer(969917),
      latinname == "vibrio_fisheri" ~ as.integer(959178),
      TRUE ~ as.integer(tsn)
    )
  )
```

```{r}
taxa_need_tsn.df <- taxa.df %>%
  filter(tsn==0)
``` 

changed all org_tsn references to tsn, because org_tsn does not exist in bay.temp.
Also, first row is na's and 0's suggesting that the data has a space between the header, and that total number of
ojects(3065) may be one over our actual values
```{r}
hier.wide <- lapply(unique(bay.temp$tsn), function(tsn.i) {
 #print(tsn.i)
  
  if(ncol(usage(tsn.i)) == 0) return(data.frame(tsn = as.integer(tsn.i),
                                                stringsAsFactors = FALSE))
  if(!ritis::usage(tsn.i)$taxonUsageRating %in% c("accepted", "valid")) {
    tsn.accepted <- ritis::accepted_names(as.integer(tsn.i))$acceptedTsn
  } else {
    tsn.accepted <- as.integer(tsn.i)
  }

  full.df <- ritis::hierarchy_full(tsn.accepted) %>%
    select(rankname, taxonname, tsn) %>%
    slice(1:which(tsn == tsn.accepted)) %>%
    mutate(tsn = as.integer(tsn.i),
           final_tsn = as.integer(tsn.accepted),
           final_id = slice(., which(tsn == tsn.accepted))$taxonname)
}
) %>%
  bind_rows() %>%
#   select(-tsn) %>% 
  #spread(rankname, taxonname) %>%
  clean_up()
```

removes the gap mentioned above
```{r}
hier.wide<- hier.wide %>%
  filter(!is.na(taxonname) & !is.na(rankname))
```

```{r}
column.vec <- c("org_tsn", "final_tsn", "final_id",
                "kingdom", "subkingdom", "infrakingdom", 
                "superdivision", "division", "subdivision", "infradivision",
                "superphylum", "phylum", "subphylum", "infraphylum", 
                "superclass", "class", "subclass", "infraclass", 
                "superorder", "order", "suborder", "infraorder", 
                "superfamily", "family", "subfamily", 
                "tribe", "subtribe", 
                "genus", "subgenus", 
                "species", "subspecies")

column.vec <- column.vec[column.vec %in% names(hier.wide)]
```

save the itis data to a csv
```{r}


data.table::fwrite(hier.wide, file.path(rprojroot::find_rstudio_root_file(), "data/itis", "itis_hierarchy.csv"))
```


####Testing
```{r}
# na <- stat_samp %>%
#   filter(is.na(stat_samp$pdepth))
# 
# not_na <- stat_samp %>%
#   filter(!is.na(stat_samp$pdepth))

# pico.df <- file.path(url.root,
#                       "LivingResources",
#                       "TidalPlankton",
#                       "Reported",
#                        min_date,
#                        # "1-1-2013",
#                        max_date, 
#                        # "12-31-2016",
#                       #"Picoplankton",
#                        "18",
#                       "Station",
#                       paste(station.vec, collapse = ",")) %>%
#   fromJSON() %>% 
#   clean_up()
# 
# stat <- pico_test.df %>%
#   select(station) %>%
#   distinct()

# no_p.df<- pdepth.df %>%
#   filter(!station%in%c("tf3.3","tf4.2","tf5.5","ret3.1","ret4.3","ret3.1") & is.na(pdepth) & layer %in% c("ap", "wc"))


            

```
